name: Build ARM64EC Wine and Package .wcp file

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build_arm64ec_wine:
    runs-on: ubuntu-latest
    env:
      LLVM_MINGW: ${{ github.workspace }}/llvm-mingw

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup QEMU for ARM emulation
        uses: docker/setup-qemu-action@v2
        with:
          platforms: aarch64

      - name: Install host dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            curl wget unzip pkgconf git cmake make \
            flex bison gettext \
            zlib1g-dev libfreetype6-dev libfontconfig1-dev \
            libx11-dev libxext-dev libxrender-dev libxml2-dev libssl-dev

      - name: Download LLVM MinGW cross-toolchain
        run: |
          TAG=$(curl -s https://api.github.com/repos/mstorsjo/llvm-mingw/releases/latest | jq -r .tag_name)
          echo "Using llvm-mingw tag: $TAG"
          wget https://github.com/mstorsjo/llvm-mingw/releases/download/${TAG}/llvm-mingw-${TAG}-ucrt-ubuntu-22.04-x86_64.tar.xz -O llvm-mingw.tar.xz
          tar xf llvm-mingw.tar.xz
          mv llvm-mingw-${TAG}-ucrt-ubuntu-22.04-x86_64 llvm-mingw

      - name: Export LLVM MinGW env
        run: |
          echo "LLVM_MINGW=${LLVM_MINGW}" >> $GITHUB_ENV
          echo "PATH=${LLVM_MINGW}/bin:$PATH" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=${LLVM_MINGW}/aarch64-w64-mingw32/lib/pkgconfig" >> $GITHUB_ENV
          echo "PKG_CONFIG_LIBDIR=${LLVM_MINGW}/aarch64-w64-mingw32/lib/pkgconfig" >> $GITHUB_ENV

      - name: Clone Wine source
        run: |
          git clone --depth 1 --branch "wine-11.1" https://gitlab.winehq.org/wine/wine.git wine-src

      - name: Build Wine tools natively (x86_64)
        working-directory: wine-src
        run: |
          # Создаём каталог wine-tools для host binaries
          mkdir -p wine-tools

          # Собираем инструменты для x86_64 (нужно для cross build)
          make tools -j$(nproc)

          # Копируем необходимые бинарники в wine-tools
          cp -a winebuild wine-tools/
          cp -a winegcc wine-tools/
          cp -a wineserver wine-tools/
          cp -a winefile wine-tools/
          
          # Проверяем содержимое
          ls -l wine-tools

      - name: Configure Wine cross-build for ARM64EC
        working-directory: wine-src
        run: |
          export CC="clang --target=aarch64-w64-mingw32 --sysroot=$LLVM_MINGW"
          export CXX="clang++ --target=aarch64-w64-mingw32 --sysroot=$LLVM_MINGW"
          export AR=aarch64-w64-mingw32-ar
          export LD=aarch64-w64-mingw32-llvm-ld
          export RANLIB=aarch64-w64-mingw32-ranlib
          export CFLAGS="-O3 -fno-plt -march=armv8.2-a+fp16+dotprod -mtune=cortex-x2 -funroll-loops"
          export CXXFLAGS="$CFLAGS"
          export LDFLAGS="-fuse-ld=lld -Wl,-O1"

          ./configure \
            --host=aarch64-w64-mingw32 \
            --enable-archs=arm64ec \
            --with-mingw=clang \
            --disable-tests \
            --without-x \
            --prefix=/usr \
            --with-wine-tools=$PWD/wine-tools

      - name: Build Wine ARM64EC
        working-directory: wine-src
        run: make -j$(nproc)

      - name: Install Wine to artifact
        working-directory: wine-src
        run: make DESTDIR=$PWD/artifact install

      - name: Package Wine ARM64EC into .wcp
        run: |
          mkdir -p wine-arm64ec-wcp/arch/arm64ec/{bin,lib,etc}
          cp -a wine-src/artifact/usr/bin/* wine-arm64ec-wcp/arch/arm64ec/bin/
          cp -a wine-src/artifact/usr/lib/* wine-arm64ec-wcp/arch/arm64ec/lib/

          cat << 'EOF' > wine-arm64ec-wcp/manifest.json
          {
            "name": "Wine11-ARM64EC",
            "version": "wine-11.1",
            "arch": "arm64ec",
            "runtime": "winlator-ludashi"
          }
          EOF

          echo "wine-11.1" > wine-arm64ec-wcp/version.txt

          cat << 'EOF' > wine-arm64ec-wcp/arch/arm64ec/etc/env.sh
          #!/bin/sh
          export WINEDEBUG="-all"
          export WINE_ENABLE_ARM64EC=1
          EOF

          chmod +x wine-arm64ec-wcp/arch/arm64ec/etc/env.sh

      - name: Upload .wcp artifact
        uses: actions/upload-artifact@v4
        with:
          name: wine-arm64ec-wcp
          path: wine-arm64ec-wcp
