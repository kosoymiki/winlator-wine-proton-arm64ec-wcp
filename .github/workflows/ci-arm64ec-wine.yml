name: Wine 11.1 ARM64EC PHAT Build

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      MAKEFLAGS: -j$(nproc)

    steps:

    # ---------------------------------------
    # Checkout sources
    # ---------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # ---------------------------------------
    # SYSTEM SETUP
    # (install dependencies, pkg-config, freetype, etc.)
    # ---------------------------------------
    - name: System setup (stable, jammy, ARM64EC)
      run: |
         set -euxo pipefail

         sudo dpkg --add-architecture i386 || true
         sudo apt-get update

         # В Ubuntu Jammy pkgconf уже установлен, конфликтует с pkg-config
         # Устанавливаем только pkgconf
         sudo apt-get install -y --no-install-recommends pkgconf

         # Остальные dev зависимости...
         sudo apt-get install -y --no-install-recommends \
         build-essential git python3 ca-certificates \
         clang lld llvm \
         gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
         flex bison autoconf automake libtool \
         libx11-dev libxext-dev libxrandr-dev libxrender-dev \
         libxi-dev libxinerama-dev libxcursor-dev \
         libxcomposite-dev libxfixes-dev libxkbcommon-dev \
         libdrm-dev libvulkan-dev \
         libpulse-dev libasound2-dev \
         libdbus-1-dev libpcap-dev \
         libsdl2-dev \
         libavcodec-dev libavformat-dev libavutil-dev libswscale-dev \
         inotify-tools libinotifytools0-dev \
         libpcsclite-dev gettext \
         libfreetype6-dev libfreetype6-dev:i386

         sudo ln -sf /usr/include/freetype2 /usr/include/freetype



    # ---------------------------------------
    # LLVM MinGW (prebuilt toolchain)
    # ---------------------------------------
    - name: LLVM MinGW
      run: |
        wget -qO llvm-mingw.tar.xz \
          https://github.com/mstorsjo/llvm-mingw/releases/download/20251216/llvm-mingw-20251216-ucrt-ubuntu-22.04-x86_64.tar.xz
        tar -xJf llvm-mingw.tar.xz
        echo "$PWD/llvm-mingw-20251216-ucrt-ubuntu-22.04-x86_64/bin" >> $GITHUB_PATH

    # ---------------------------------------
    # Clone Wine + Staging
    # ---------------------------------------
    - name: Clone Wine + Staging
      run: |
        git clone --depth 1 -b wine-11.1 https://gitlab.winehq.org/wine/wine.git wine
        git clone --depth 1 -b v11.1 https://gitlab.winehq.org/wine/wine-staging.git staging

    # ---------------------------------------
    # Apply Wine Staging
    # ---------------------------------------
    - name: Apply Wine-Staging patches
      run: |
        cd staging
        ./staging/patchinstall.py DESTDIR=../wine --all --no-autoconf
        cd ../wine
        autoreconf -fiv

    # ---------------------------------------
    # Build host winetools
    # ---------------------------------------
    - name: Build host Winetricks/Tools
      run: |
        mkdir host && cd host
        ../wine/configure --enable-win64 --disable-tests
        make __tooldeps__

    # ---------------------------------------
    # Configure & Build Wine (ARM64EC + WoW64)
    # ---------------------------------------
    - name: Configure & build Wine
      run: |
        mkdir -p build
        cd build

        export PKG_CONFIG=pkg-config
        export CPPFLAGS="-I/usr/include/freetype2 ${CPPFLAGS:-}"

        ../wine/configure \
          --host=aarch64-w64-mingw32 \
          --with-wine-tools=../host \
          --enable-win64 \
          --enable-wow64 \
          --enable-archs=arm64ec,aarch64 \
          --disable-tests \
          --with-freetype \
          --with-fontconfig \
          --with-sdl2 \
          --with-alsa \
          --with-pulse \
          --with-db \
          --with-inotify \
          --with-pcap \
          --with-ffmpeg

        make -j$(nproc)
        DESTDIR=$PWD/install make install

    # ---------------------------------------
    # Prepare PHAT structure
    # ---------------------------------------
    - name: Create PHAT WCP structure
      run: |
        set -euxo pipefail

        WINE_INSTALL="$PWD/build/install/usr"
        PHAT="$PWD/build/install/wcp"
        mkdir -p "$PHAT"

        # Binaries
        mkdir -p "$PHAT/bin"
        cp "$WINE_INSTALL/bin/wine" "$PHAT/bin/"
        cp "$WINE_INSTALL/bin/wine64" "$PHAT/bin/"
        cp "$WINE_INSTALL/bin/wineserver" "$PHAT/bin/"
        cp "$WINE_INSTALL/bin/wineboot" "$PHAT/bin/"

        # Libraries
        mkdir -p "$PHAT/lib/wine/aarch64-unix"
        mkdir -p "$PHAT/lib/wine/aarch64-windows"
        mkdir -p "$PHAT/lib/wine/arm64ec-windows"

        find "$WINE_INSTALL/lib" -type f -name "*.so" ! -name "*.dll.so" \
          -exec cp {} "$PHAT/lib/wine/aarch64-unix/" \;

        find "$WINE_INSTALL/lib" -type f -name "*.dll.so" \
          -exec cp {} "$PHAT/lib/wine/aarch64-windows/" \;

        find "$WINE_INSTALL/lib/arm64ec-windows" -type f -name "*.dll.so" \
          -exec cp {} "$PHAT/lib/wine/arm64ec-windows/" \;

        # Shared data
        mkdir -p "$PHAT/share/wine"
        cp -a "$WINE_INSTALL/share/wine/." "$PHAT/share/wine/"

        # DXVK
        mkdir -p "$PHAT/dxvk/arm64ec"
        if [ -d "$PWD/dxvk.wcp/arm64ec" ]; then
          cp -a "$PWD/dxvk.wcp/arm64ec/." "$PHAT/dxvk/arm64ec/"
        fi

        # VKD3D
        mkdir -p "$PHAT/vkd3d/arm64ec"
        if [ -d "$PWD/vkd3d.wcp/arm64ec" ]; then
          cp -a "$PWD/vkd3d.wcp/arm64ec/." "$PHAT/vkd3d/arm64ec/"
        fi

        # Mesa / Turnip
        mkdir -p "$PHAT/mesa/turnip"
        if [ -d "$PWD/turnip/mesa/turnip" ]; then
          cp -a "$PWD/turnip/mesa/turnip/." "$PHAT/mesa/turnip/"
        fi

        # env.sh
        cat > "$PHAT/env.sh" << 'EOF'
        #!/bin/sh
        export WINEDEBUG=-all
        export WINE_NTSYNC=1
        export WINEESYNC=0
        export WINEFSYNC=0
        EOF
        chmod +x "$PHAT/env.sh"

        # info.json
        cat > "$PHAT/info.json" << 'EOF'
        {
          "name": "Wine 11.1 ARM64EC PHAT",
          "version": "11.1",
          "build": "PHAT",
          "arch": "arm64ec",
          "components": {
            "wine": true,
            "dxvk": true,
            "vkd3d": true,
            "turnip": true
          }
        }
        EOF

        # Validate arm64ec libs
        test -d "$PHAT/lib/wine/arm64ec-windows" || (echo "Missing arm64ec-windows libs!" && exit 1)

        # Pack to .wcp
        tar -cJf "$GITHUB_WORKSPACE/wine-11.1-arm64ec-phat.wcp" -C "$PHAT" .

    # ---------------------------------------
    # Upload artifact
    # ---------------------------------------
    - name: Upload Wine PHAT artifact
      uses: actions/upload-artifact@v4
      with:
        name: wine-11.1-arm64ec-phat
        path: ./wine-11.1-arm64ec-phat.wcp
