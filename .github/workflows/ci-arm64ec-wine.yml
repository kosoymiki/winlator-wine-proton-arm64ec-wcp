name: Build Wine 11.1 Staging ARM64EC PHAT wcp

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-arm64ec:
    runs-on: ubuntu-24.04-arm

    defaults:
      run:
        shell: bash

    steps:

    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install base build dependencies
      run: |
        set -euxo pipefail
        sudo apt update
        sudo apt install -y --no-install-recommends \
          build-essential git wget curl python3 perl gettext \
          pkgconf cmake ninja-build meson \
          autoconf automake libtool patchutils bison flex \
          libc6-dev linux-libc-dev \
          libfreetype-dev libfontconfig-dev libdbus-1-dev \
          libx11-dev libxext-dev libxrender-dev \
          libxrandr-dev libxinerama-dev libxcursor-dev \
          libxi-dev libxfixes-dev libsdl2-dev \
          libpulse-dev libasound2-dev \
          libudev-dev libgl-dev \
          libusb-1.0-0-dev libpcap-dev \
          libxcomposite-dev libxdamage-dev \
          libv4l-dev libopencv-dev \
          libpcsclite-dev libkrb5-dev libcups2-dev \
          libgnutls28-dev libsane-dev \
          rsync file zip xz-utils
        sudo ln -sf /usr/bin/pkgconf /usr/local/bin/pkg-config || true
        pkg-config --version
        gcc --version
        g++ --version

    - name: Setup llvm-mingw (prebuilt Linux cross)
      run: |
        set -euxo pipefail
        ROOT="$(pwd)"
        LLVM_MINGW_VERSION="20251216"
        ASSET="llvm-mingw-${LLVM_MINGW_VERSION}-ucrt-ubuntu-22.04-aarch64.tar.xz"
        URL="https://github.com/mstorsjo/llvm-mingw/releases/download/${LLVM_MINGW_VERSION}/${ASSET}"
        rm -rf "$ROOT/llvm-mingw"
        mkdir -p "$ROOT/llvm-mingw"
        wget -q "$URL" -O "$ROOT/$ASSET"
        tar -xJf "$ROOT/$ASSET" -C "$ROOT/llvm-mingw" --strip-components=1
        rm -f "$ROOT/$ASSET"
        echo "$ROOT/llvm-mingw/bin" >> "$GITHUB_PATH"
        # Diagnostics: list available cross compilers
        ls -1 "$ROOT/llvm-mingw/bin" | head -n 60 || true

    - name: Verify llvm-mingw cross toolchain
      run: |
        set -euxo pipefail
        arm64ec-w64-mingw32-clang --version
        arm64ec-w64-mingw32-clang++ --version

    - name: Clone Wine & Wine-Staging
      run: |
        set -euxo pipefail
        git clone --depth 1 --branch wine-11.1 https://gitlab.winehq.org/wine/wine.git wine
        git clone --depth 1 --branch v11.1 https://gitlab.winehq.org/wine/wine-staging.git wine-staging

    - name: Apply staging patches
      run: |
        set -euxo pipefail
        ROOT="$(pwd)"
        python3 wine-staging/staging/patchinstall.py -d wine -a --no-autoconf
        cd wine
        autoreconf -fiv
        ./tools/make_requests

    - name: Build wine-tools (native)
      run: |
        set -euxo pipefail
        ROOT="$(pwd)"

        cd wine

        # 1) Autotools генерация для Wine (host/native)
        autoreconf -fiv

        # 2) Полная конфигурация для wine‑tools (host build)
        ./configure \
          --disable-tests \
          --disable-win16 \
          --enable-tools \
          --with-freetype \
          --with-fontconfig

        # 3) Собрать только инструменты
        make -j"$(nproc)" tools/winebuild/winebuild \
                         tools/widl/widl \
                         tools/wrc/wrc \
                         tools/wmc/wmc \
                         tools/makedep/makedep

        # 4) Установить wine-tools в отдельную директорию
        WORKTOOLS="$ROOT/wine-tools"
        mkdir -p "$WORKTOOLS/tools"
        cp tools/winebuild/winebuild "$WORKTOOLS/tools/"
        cp tools/widl/widl           "$WORKTOOLS/tools/"
        cp tools/wrc/wrc             "$WORKTOOLS/tools/"
        cp tools/wmc/wmc             "$WORKTOOLS/tools/"
        cp tools/makedep/makedep     "$WORKTOOLS/tools/"

    - name: Configure Wine (cross ARM64EC)
      run: |
        set -euxo pipefail
        ROOT="$(pwd)"
        export PATH="$ROOT/llvm-mingw/bin:$PATH"

        rm -rf wine-build
        mkdir wine-build
        cd wine-build

        export CC=arm64ec-w64-mingw32-clang
        export CXX=arm64ec-w64-mingw32-clang++

        # 1) Указать wine-tools, собранные ранее
        "$ROOT/wine/configure" \
          --prefix=/usr \
          --with-wine-tools="$ROOT/wine-tools" \
          --host=arm64ec-w64-mingw32 \
          --sysroot="$ROOT/llvm-mingw/aarch64-unknown-linux-gnu" \
          --enable-win64 \
          --enable-wow64 \
          --enable-archs=arm64ec,aarch64 \
          --disable-tests \
          --with-freetype \
          --with-fontconfig \
          --with-dbus \
          --with-alsa \
          --with-pulse

    - name: Build Wine
      run: |
        set -euxo pipefail
        cd wine-build
        make -j"$(nproc)"

    - name: Install Wine
      run: |
        set -euxo pipefail
        cd wine-build
        DESTDIR="$PWD/wine-install" make install

    - name: Assemble PHAT wcp
      run: |
        set -euxo pipefail
        ROOT="$(pwd)"
        mkdir -p wcp/{bin,lib/wine,dxvk/arm64ec,vkd3d/arm64ec,mesa/turnip}
        cp wine-install/usr/bin/{wine,wine64,wineboot,wineserver} wcp/bin/
        rsync -a wine-install/usr/lib/wine/ wcp/lib/wine/

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: wine-arm64ec-phat
        path: wcp
