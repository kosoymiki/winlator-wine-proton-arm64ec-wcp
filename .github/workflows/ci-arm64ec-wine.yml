name: Build Wine 11.1 Staging ARM64EC PHAT wcp

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-arm64ec:
    runs-on: ubuntu-24.04-arm
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install base deps
        run: |
          set -euxo pipefail
          sudo apt update
          sudo apt install -y --no-install-recommends \
            build-essential git wget python3 perl gettext \
            pkgconf cmake ninja-build meson \
            autoconf automake libtool \
            patchutils bison flex \
            libc6-dev \
            libfreetype6-dev \
            libfontconfig-dev \
            libx11-dev libxext-dev libxrender-dev \
            libxrandr-dev libxinerama-dev libxcursor-dev \
            libxi-dev libxfixes-dev libxcomposite-dev \
            libsdl2-dev libpulse-dev libasound2-dev \
            libdbus-1-dev libudev-dev libgl-dev \
            rsync file zip xz-utils
          sudo ln -sf /usr/bin/pkgconf /usr/local/bin/pkg-config || true


      - name: Setup llvm-mingw
        run: |
          set -euxo pipefail
          ROOT="$(pwd)"
          LLVM_MINGW_VERSION="20251216"
          rm -rf "$ROOT/llvm-mingw"
          mkdir -p "$ROOT/llvm-mingw"
          wget -q "https://github.com/mstorsjo/llvm-mingw/releases/download/${LLVM_MINGW_VERSION}/llvm-mingw-${LLVM_MINGW_VERSION}-ucrt-ubuntu-22.04-aarch64.tar.xz"
          tar -xJf "llvm-mingw-${LLVM_MINGW_VERSION}-ucrt-ubuntu-22.04-aarch64.tar.xz" -C "$ROOT/llvm-mingw" --strip-components=1
          rm -f "llvm-mingw-${LLVM_MINGW_VERSION}-ucrt-ubuntu-22.04-aarch64.tar.xz"
          echo "$ROOT/llvm-mingw/bin" >> "$GITHUB_PATH"

      - name: Verify cross compiler
        run: |
          set -euxo pipefail
          command -v aarch64-w64-mingw32-clang
          aarch64-w64-mingw32-clang --version
          echo 'int main(void){return 0;}' > /tmp/test.c
          aarch64-w64-mingw32-clang -o /tmp/test.exe /tmp/test.c -Wl,--no-undefined
          file /tmp/test.exe

      - name: Clone Wine & Wine-Staging
        run: |
          set -euxo pipefail
          rm -rf wine wine-staging
          git clone --depth 1 --branch wine-11.1 https://gitlab.winehq.org/wine/wine.git wine
          git clone --depth 1 --branch v11.1 https://gitlab.winehq.org/wine/wine-staging.git wine-staging

      - name: Apply staging patches
        run: |
          set -euxo pipefail
          ROOT="$(pwd)"
          python3 wine-staging/staging/patchinstall.py -d "$ROOT/wine" -a --no-autoconf
          cd "$ROOT/wine"
          autoreconf -fiv
          ./tools/make_requests

      # ---- BUILD WINE TOOLS (native) ----
      - name: Build wine tools
        run: |
          set -euxo pipefail
          ROOT="$(pwd)"

          # remove old
          rm -rf "$ROOT/wine-tools"
          mkdir -p "$ROOT/wine-tools"

          # build‑tree inside wine source
          cd "$ROOT/wine"
          rm -rf tools-build
          mkdir tools-build
          cd tools-build

          # configure for tools
          ../configure \
            --disable-tests \
            --disable-win16 \
            --with-freetype \
            --with-fontconfig \
            --without-vulkan \
            --without-dbus \
            --without-alsa \
            --without-pulse \
            --without-wayland \
            --without-sdl2

          # build only needed targets
          make -j"$(nproc)" \
            tools/winebuild/winebuild \
            tools/widl/widl \
            tools/wrc/wrc \
            tools/makedep \
            tools/winegcc/winegcc \
            tools/wmc/wmc

          # install tools into wine-tools with correct structure
          mkdir -p "$ROOT/wine-tools/tools/winebuild"
          mkdir -p "$ROOT/wine-tools/tools/widl"
          mkdir -p "$ROOT/wine-tools/tools/wrc"
          mkdir -p "$ROOT/wine-tools/tools/winegcc"
          mkdir -p "$ROOT/wine-tools/tools/wmc"

          cp tools/winebuild/winebuild "$ROOT/wine-tools/tools/winebuild/"
          cp tools/widl/widl           "$ROOT/wine-tools/tools/widl/"
          cp tools/wrc/wrc             "$ROOT/wine-tools/tools/wrc/"
          cp tools/makedep             "$ROOT/wine-tools/tools/"
          cp tools/winegcc/winegcc     "$ROOT/wine-tools/tools/winegcc/"
          cp tools/wmc/wmc             "$ROOT/wine-tools/tools/wmc/"

          # test structure
          ls -lR "$ROOT/wine-tools/tools"
          test -f "$ROOT/wine-tools/tools/makedep"
          test -x "$ROOT/wine-tools/tools/winebuild/winebuild"
          test -x "$ROOT/wine-tools/tools/widl/widl"
          test -x "$ROOT/wine-tools/tools/wrc/wrc"
          test -x "$ROOT/wine-tools/tools/winegcc/winegcc"
          test -x "$ROOT/wine-tools/tools/wmc/wmc"

      # ---- CROSS CONFIGURE ----
      - name: Configure Wine (cross ARM64EC)
        run: |
          set -euxo pipefail
          ROOT="$(pwd)"
          export PATH="$ROOT/llvm-mingw/bin:$PATH"

          rm -rf "$ROOT/wine-build"
          mkdir -p "$ROOT/wine-build"
          cd "$ROOT/wine-build"

          export CC=aarch64-w64-mingw32-clang
          export CXX=aarch64-w64-mingw32-clang++
          export AR=aarch64-w64-mingw32-ar
          export RANLIB=aarch64-w64-mingw32-ranlib
          export STRIP=aarch64-w64-mingw32-strip

          "$ROOT/wine/configure" \
            --host=aarch64-w64-mingw32 \
            --prefix=/usr \
            --with-wine-tools="$ROOT/wine-tools" \
            --enable-win64 \
            --enable-wow64 \
            --enable-archs=arm64ec,aarch64 \
            --disable-tests

      - name: Build Wine
        run: |
          set -euxo pipefail
          ROOT="$(pwd)"
          cd "$ROOT/wine-build"
          make -j"$(nproc)"

      - name: Install Wine
        run: |
          set -euxo pipefail
          ROOT="$(pwd)"
          cd "$ROOT/wine-build"
          rm -rf "$ROOT/wine-install"
          DESTDIR="$ROOT/wine-install" make install

      # …оставляем дальше твою сборку mesa, dxvk, vkd3d, fexcore и wcp…

      - name: Assemble PHAT wcp
        run: |
          set -euxo pipefail
          ROOT="$(pwd)"
          rm -rf "$ROOT/wcp"
          mkdir -p "$ROOT/wcp"/{bin,lib/wine,dxvk/arm64ec,vkd3d/arm64ec,mesa/turnip}
          cp -v "$ROOT/wine-install/usr/bin/"{wine,wine64,wineboot,wineserver} "$ROOT/wcp/bin/" || true
          rsync -a "$ROOT/wine-install/usr/lib/wine/" "$ROOT/wcp/lib/wine/" || true
          # …и так далее…

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wine-arm64ec-phat
          path: wcp
