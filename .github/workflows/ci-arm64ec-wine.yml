name: Wine 11.1 Staging PHAT + NTsync + DXVK + VKD3D ARM64EC (FINAL STABLE)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      MAKEFLAGS: -j1

    steps:
      - uses: actions/checkout@v4

      # ============================================================
      # SYSTEM SETUP
      # ============================================================
      - name: System setup
        run: |
         set -e

         sudo dpkg --add-architecture arm64

         sudo tee /etc/apt/preferences.d/no-security-arm64 <<'EOF'
         Package: *
         Pin: origin security.ubuntu.com
         Pin-Priority: -1
         EOF


         sudo tee /etc/apt/sources.list.d/arm64-ports.list <<'EOF'
         deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy main universe multiverse
         deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy-updates main universe multiverse
         deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy-security main universe multiverse
         EOF

         sudo apt update



         sudo apt install -y --no-install-recommends \
         build-essential git python3 ca-certificates \
         clang lld llvm \
         gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
         flex bison autoconf automake libtool pkg-config \
         \
         # X11 / graphics (host)
         libx11-dev libxext-dev libxrandr-dev libxrender-dev \
         libxi-dev libxinerama-dev libxcursor-dev \
         libxcomposite-dev libxfixes-dev libxkbcommon-dev \
         libdrm-dev libvulkan-dev \
         \
         # Fonts / text (host)
         libfreetype-dev libfontconfig1-dev \
         \
         # Audio / misc (host, optional but safe)
         libpulse-dev libasound2-dev libdbus-1-dev \
         \
         # ARM64 unix-side (WOW64 runtime)
         libx11-dev:arm64 libxext-dev:arm64 libxrandr-dev:arm64 \
         libxrender-dev:arm64 libxi-dev:arm64 libxinerama-dev:arm64 \
         libxcursor-dev:arm64 libxcomposite-dev:arm64 libxfixes-dev:arm64 \
         libxkbcommon-dev:arm64 libdrm-dev:arm64 libvulkan-dev:arm64 \
         libfreetype-dev:arm64 libfontconfig1-dev:arm64


      # ============================================================
      # LLVM MinGW
      # ============================================================
      - name: LLVM MinGW
        run: |
          wget -qO llvm-mingw.tar.xz \
            https://github.com/mstorsjo/llvm-mingw/releases/download/20251216/llvm-mingw-20251216-ucrt-ubuntu-22.04-x86_64.tar.xz
          tar -xJf llvm-mingw.tar.xz
          echo "$PWD/llvm-mingw-20251216-ucrt-ubuntu-22.04-x86_64/bin" >> $GITHUB_PATH

      # ============================================================
      # SOURCES
      # ============================================================
      - name: Clone Wine + Staging
        run: |
          git clone --depth 1 -b wine-11.1 https://gitlab.winehq.org/wine/wine.git wine
          git clone --depth 1 -b v11.1 https://gitlab.winehq.org/wine/wine-staging.git staging

      # ============================================================
      # APPLY STAGING (SAFE)
      # ============================================================
      - name: Apply Wine-Staging
        run: |
          cd staging
          ./staging/patchinstall.py DESTDIR=../wine --all --no-autoconf
          cd ../wine
          autoreconf -fiv

      # ============================================================
      # HOST WINETOOLS
      # ============================================================
      - name: Build host winetools
        run: |
          mkdir host && cd host
          ../wine/configure --enable-win64 --disable-tests
          make __tooldeps__

      # ============================================================
      # ARM64EC + WOW64 BUILD
      # ============================================================
      - name: Build Wine ARM64EC
        run: |
          mkdir build && cd build

          export CC=aarch64-w64-mingw32-clang
          export CXX=aarch64-w64-mingw32-clang++
          export OPT="-O3 -march=armv8.2-a+fp16+dotprod"
          export CFLAGS="$OPT -Wno-error"
          export CXXFLAGS="$OPT -Wno-error"

          ../wine/configure \
            --host=aarch64-w64-mingw32 \
            --with-wine-tools=../host \
            --enable-win64 \
            --enable-wow64 \
            --enable-archs=arm64ec,aarch64 \
            --disable-tests \
            --without-x \
            --without-wayland \
            --without-cups \
            --without-sane

          make
          DESTDIR=$PWD/install make install

      # ============================================================
      # PHAT WCP
      # ============================================================
      - name: Create PHAT WCP
        run: |
          cd build/install
          mkdir -p wcp/{bin,lib/wine/{aarch64-unix,aarch64-windows},share}
          cp usr/bin/* wcp/bin/
          ln -sf wine64 wcp/bin/wine
          find usr/lib -name "*.dll.so" -exec cp {} wcp/lib/wine/aarch64-windows/ \;
          find usr/lib -name "*.so" ! -name "*.dll.so" -exec cp {} wcp/lib/wine/aarch64-unix/ \;
          cp -a usr/share/wine wcp/share/

          cat > wcp/env.sh <<'EOF'
          #!/bin/sh
          export WINEDEBUG=-all
          export WINE_NTSYNC=1
          export WINEESYNC=0
          export WINEFSYNC=0
          EOF
          chmod +x wcp/env.sh

          tar -cJf $GITHUB_WORKSPACE/wine-11.1-staging-phat-ntsync-arm64ec.wcp -C wcp .

      # ============================================================
      # UPLOAD
      # ============================================================
      - uses: actions/upload-artifact@v4
        with:
          name: wine-11.1-staging-phat-ntsync-arm64ec
          path: wine-11.1-staging-phat-ntsync-arm64ec.wcp
