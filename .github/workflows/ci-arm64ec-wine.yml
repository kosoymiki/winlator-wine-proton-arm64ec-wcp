name: Build Native Wine 11 ARM64 for Winlator

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build_wine_arm64:
    runs-on: ubuntu-24.04
    # Используем контейнер с поддержкой multiarch, чтобы не мучиться с dpkg в runner
    # Но для GitHub actions проще настроить runner.

    env:
      LLVM_MINGW_URL: https://github.com/mstorsjo/llvm-mingw/releases/download/20231128/llvm-mingw-20231128-ucrt-ubuntu-20.04-aarch64-linux-gnu.tar.xz
      # Внимание: берем llvm-mingw, который запускается на x86_64, но таргетит aarch64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Multiarch and Dependencies (Host & Target)
        run: |
          sudo dpkg --add-architecture arm64
          sudo apt-get update
          # Устанавливаем кросс-компилятор GCC (для Linux-части) и нативные тулзы
          sudo apt-get install -y \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            flex bison git cmake ninja-build \
            gcc make gcc-multilib \
            libx11-dev:arm64 libfreetype-dev:arm64 libwayland-dev:arm64 \
            libxrender-dev:arm64 libxext-dev:arm64 libxi-dev:arm64 \
            libglib2.0-dev:arm64 libgstreamer1.0-dev:arm64 \
            libudev-dev:arm64 libsdl2-dev:arm64 libvulkan-dev:arm64

      - name: Setup LLVM MinGW (PE Compiler)
        run: |
          wget https://github.com/mstorsjo/llvm-mingw/releases/download/20231128/llvm-mingw-20231128-ucrt-ubuntu-20.04-x86_64.tar.xz -O llvm-mingw.tar.xz
          tar xf llvm-mingw.tar.xz
          mv llvm-mingw-20231128-ucrt-ubuntu-20.04-x86_64 llvm-mingw
          echo "$PWD/llvm-mingw/bin" >> $GITHUB_PATH

      - name: Clone Wine Source
        run: |
          # Берем master для последних фич ARM64
          git clone --depth 1 https://gitlab.winehq.org/wine/wine.git wine-src

      - name: Build Wine Tools (x86_64 Native)
        run: |
          mkdir wine-tools
          cd wine-tools
          ../wine-src/configure --enable-win64
          make -j$(nproc) tools \
            include/x11drv_idl.h include/waylanddrv_client_protocol.h
          # Сборка минимально необходимых заголовков

      - name: Apply Patches (Fsync/Optimization)
        working-directory: wine-src
        run: |
          # Пример: берем staging патчи (опционально, нужно следить за версиями)
          # wget https://raw.githubusercontent.com/wine-staging/wine-staging/master/patches/ntdll-Junction_Points/0001-ntdll-Implement-reparse-point-support-for-Junctions.patch
          # git apply ...
          echo "Skipping patches for pure master build"

      - name: Configure Wine (Cross-Compile ARM64)
        run: |
          mkdir wine-build
          cd wine-build
          
          # Флаги для Snapdragon 8+ Gen 1
          export CFLAGS="-O3 -mcpu=cortex-x2 -mtune=cortex-x2 -fno-plt"
          export CROSSCFLAGS="-O3 -mcpu=cortex-x2 -mtune=cortex-x2 -g0" 
          # g0 убирает дебаг инфо из DLL, сильно уменьшая размер
          
          # Указываем pkg-config для ARM64
          export PKG_CONFIG_PATH=/usr/lib/aarch64-linux-gnu/pkgconfig
          
          ../wine-src/configure \
            --host=aarch64-linux-gnu \
            --with-wine64 \
            --without-wine \
            --with-wine-tools=../wine-tools \
            --with-mingw=clang \
            --prefix=/opt/wine-custom \
            --disable-tests \
            --with-x \
            --with-wayland \
            --with-vulkan

      - name: Build Wine
        working-directory: wine-build
        run: make -j$(nproc)

      - name: Install to Staging
        working-directory: wine-build
        run: make install DESTDIR=$PWD/../image

      - name: Package .wcp
        run: |
          cd image/opt
          mv wine-custom Wine-11.0-ARM64
          
          # Генерация info.json
          cat <<EOF > Wine-11.0-ARM64/info.json
          {
            "name": "Wine-11.0-ARM64-Native",
            "version": "11.0-git",
            "arch": "arm64",
            "author": "CI-Bot",
            "description": "Native AArch64 build for Winlator (No Box64 needed)"
          }
          EOF
          
          # Упаковка в .tar.xz (Winlator воспринимает это как wcp)
          tar -cJf ../../wine-arm64-native.wcp Wine-11.0-ARM64
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: wine-arm64-native.wcp
          path: wine-arm64-native.wcp
