name: Build Wine 11.1 WoW64 ARM64EC

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-24.04-arm

    env:
      MAKEFLAGS: -j$(nproc)

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: System deps (native + features)
        run: |
          set -euxo pipefail
          sudo apt-get update

          # базовая сборка + генераторы
          sudo apt-get install -y --no-install-recommends \
            build-essential git ca-certificates curl xz-utils \
            pkgconf gettext \
            flex bison \
            perl python3

          # КЛЮЧЕВЫЕ фичи "не обрезанного" Wine
          sudo apt-get install -y --no-install-recommends \
            libfreetype6-dev libfontconfig1-dev \
            libdbus-1-dev \
            libasound2-dev libpulse-dev

          # GUI-драйверы (X11) + OpenGL (обычно это "must" для рабочего GUI wine)
          sudo apt-get install -y --no-install-recommends \
            libx11-dev libxext-dev libxrender-dev libxrandr-dev libxinerama-dev \
            libxi-dev libxcursor-dev libxcomposite-dev libxdamage-dev libxfixes-dev \
            libgl1-mesa-dev libglu1-mesa-dev

          # SDL2 включается авто-детектом (НЕ флагом --with-sdl2)
          sudo apt-get install -y --no-install-recommends libsdl2-dev

          # опционально (не ломает, если нет рантайма): Vulkan/Wayland headers
          sudo apt-get install -y --no-install-recommends libvulkan-dev || true
          sudo apt-get install -y --no-install-recommends libwayland-dev wayland-protocols || true

          # inotify — это sys/inotify.h из glibc headers; гарантируем, что headers стоят
          sudo apt-get install -y --no-install-recommends linux-libc-dev

      - name: Fetch llvm-mingw (your pinned release)
        run: |
          set -euxo pipefail
          ROOT="$GITHUB_WORKSPACE"

          URL="https://github.com/mstorsjo/llvm-mingw/releases/download/20251216/llvm-mingw-20251216-ucrt-ubuntu-22.04-aarch64.tar.xz"

          rm -rf "$ROOT/llvm-mingw"
          mkdir -p "$ROOT/llvm-mingw"

          curl -L "$URL" -o "$ROOT/llvm-mingw.tar.xz"
          tar -xJf "$ROOT/llvm-mingw.tar.xz" -C "$ROOT/llvm-mingw" --strip-components=1

          echo "$ROOT/llvm-mingw/bin" >> "$GITHUB_PATH"

          # sanity: компилеры должны реально существовать
          "$ROOT/llvm-mingw/bin/arm64ec-w64-mingw32-clang" --version
          "$ROOT/llvm-mingw/bin/aarch64-w64-mingw32-clang" --version
          command -v llvm-dlltool
          command -v lld || true

      - name: Build minimal wine-tools (NO full wine install)
        run: |
          set -euxo pipefail
          ROOT="$GITHUB_WORKSPACE"

          rm -rf "$ROOT/wine-tools" "$ROOT/wine-tools-build"
          mkdir -p "$ROOT/wine-tools/bin" "$ROOT/wine-tools-build"
          cd "$ROOT/wine-tools-build"

          # ВАЖНО: tools — это native сборка (Linux), НЕ mingw.
          "$ROOT/wine/configure" \
            --prefix="$ROOT/wine-tools" \
            --disable-tests

          # Собираем только то, что реально нужно дальше (и НЕ делаем make install)
          make $MAKEFLAGS \
            tools/makedep/makedep \
            tools/widl/widl \
            tools/winebuild/winebuild \
            tools/wrc/wrc \
            tools/wmc/wmc \
            tools/winegcc/winegcc \
            tools/winedump/winedump

          # Стабилизируем layout для --with-wine-tools (ожидается bin/*)
          cp -a tools/makedep/makedep   "$ROOT/wine-tools/bin/makedep"
          cp -a tools/widl/widl         "$ROOT/wine-tools/bin/widl"
          cp -a tools/winebuild/winebuild "$ROOT/wine-tools/bin/winebuild"
          cp -a tools/wrc/wrc           "$ROOT/wine-tools/bin/wrc"
          cp -a tools/wmc/wmc           "$ROOT/wine-tools/bin/wmc"
          cp -a tools/winegcc/winegcc   "$ROOT/wine-tools/bin/winegcc"
          cp -a tools/winedump/winedump "$ROOT/wine-tools/bin/winedump"

          ln -sf winegcc "$ROOT/wine-tools/bin/wineg++"
          ln -sf winegcc "$ROOT/wine-tools/bin/winecpp"

          test -x "$ROOT/wine-tools/bin/winebuild"
          test -x "$ROOT/wine-tools/bin/makedep"
          test -x "$ROOT/wine-tools/bin/widl"

      - name: Configure Wine (native host + PE archs arm64ec,aarch64)
        run: |
          set -euxo pipefail
          ROOT="$GITHUB_WORKSPACE"

          rm -rf "$ROOT/wine-build"
          mkdir -p "$ROOT/wine-build"
          cd "$ROOT/wine-build"

          # КРИТИЧЕСКИ ВАЖНО:
          # - НЕ ставим --host=aarch64-w64-mingw32
          # - НЕ экспортируем CC/CXX в mingw
          # Иначе configure будет проверять Linux-заголовки как PE target и всё "пропадет".
          "$ROOT/wine/configure" \
            --prefix=/usr \
            --with-wine-tools="$ROOT/wine-tools" \
            --enable-win64 \
            --enable-wow64 \
            --enable-archs=arm64ec,aarch64 \
            --disable-tests \
            --with-freetype \
            --with-fontconfig \
            --with-dbus

      - name: Build & stage install
        run: |
          set -euxo pipefail
          ROOT="$GITHUB_WORKSPACE"
          cd "$ROOT/wine-build"

          make $MAKEFLAGS
          make install DESTDIR="$ROOT/wine-install"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wine-wow64-arm64ec
          path: wine-install
