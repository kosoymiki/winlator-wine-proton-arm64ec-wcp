name: Build Wine 11.1 ARM64EC PHAT

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      MAKEFLAGS: -j$(nproc)
      HOST_TRIPLET: aarch64-w64-mingw32
      SYSROOT: /usr/aarch64-linux-gnu

    steps:

    - name: Checkout
      uses: actions/checkout@v4

    # -------------------------
    # System setup (cross dev + pkgconf)
    # -------------------------
    - name: System setup (cross dev)
      run: |
        set -euxo pipefail

        sudo apt-get update

        # Базовые сборочные инструменты и кросс gcc
        sudo apt-get install -y --no-install-recommends \
          build-essential \
          gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
          autotools-dev autoconf automake libtool \
          git ca-certificates python3 gettext \
          pkgconf

        # libc6 cross headers (glibc sysroot includes; inotify etc.)
        sudo apt-get install -y --no-install-recommends \
          libc6-dev-arm64-cross

        # Cross‑dev пакеты для обязательных библиотек (freetype, fontconfig, SDL2, pulse/alsa, dbus, ffmpeg)
        sudo apt-get install -y --no-install-recommends \
          libfreetype6-dev-arm64-cross \
          libfontconfig1-dev-arm64-cross \
          libsdl2-dev-arm64-cross \
          libpulse-dev-arm64-cross \
          libasound2-dev-arm64-cross \
          libdbus-1-dev-arm64-cross \
          libdb-dev-arm64-cross \
          libavcodec-dev-arm64-cross \
          libavformat-dev-arm64-cross \
          libavutil-dev-arm64-cross \
          libswscale-dev-arm64-cross

        # Используем pkgconf как pkg-config (pkg-config конфликтует с pkgconf в Jammy)
        sudo ln -sf /usr/bin/pkgconf /usr/local/bin/pkg-config

    # -------------------------
    # LLVM MinGW (PE aarch64ec target tools)
    # -------------------------
    - name: LLVM MinGW
      run: |
        set -euxo pipefail
        wget -qO llvm-mingw.tar.xz \
          https://github.com/mstorsjo/llvm-mingw/releases/download/20251216/llvm-mingw-20251216-ucrt-ubuntu-22.04-x86_64.tar.xz
        tar -xf llvm-mingw.tar.xz
        # добавляем llvm‑mingw в PATH для mingw‑toolchain
        echo "$PWD/llvm-mingw-20251216-ucrt-ubuntu-22.04-x86_64/bin" >> $GITHUB_PATH

    # -------------------------
    # Clone Wine + Staging
    # -------------------------
    - name: Clone Wine + Wine-Staging
      run: |
        set -euxo pipefail
        git clone --depth 1 -b wine-11.1 https://gitlab.winehq.org/wine/wine.git wine
        git clone --depth 1 -b v11.1 https://gitlab.winehq.org/wine/wine-staging.git staging
        cd staging
        ./staging/patchinstall.py DESTDIR=../wine --all --no-autoconf

    # -------------------------
    # Build host winetools
    # -------------------------
    - name: Build host winetools
      run: |
        set -euxo pipefail
        mkdir -p wine/host && cd wine/host
        ../wine/configure \
          --disable-tests \
          --without-x \
          --without-wayland
        make

    # -------------------------
    # Configure & Build Wine
    # -------------------------
    - name: Configure & Build Wine
      run: |
        set -euxo pipefail
        cd wine

        mkdir -p build
        cd build

        export PKG_CONFIG=pkgconf
        export CPPFLAGS="
          -I${SYSROOT}/include
          -I${SYSROOT}/include/aarch64-linux-gnu
          -I/usr/include/freetype2
          -I/usr/include/SDL2
        "
        export LDFLAGS="-L${SYSROOT}/lib"

        ../configure \
          --host=${HOST_TRIPLET} \
          --with-wine-tools=../host \
          --enable-win64 \
          --enable-wow64 \
          --enable-archs=arm64ec,aarch64 \
          --disable-tests \
          --with-inotify \
          --with-freetype \
          --with-fontconfig \
          --with-sdl2 \
          --with-alsa \
          --with-pulse \
          --with-db \
          --with-ffmpeg \
          --without-pcap

        make
        DESTDIR=$PWD/install make install

    # -------------------------
    # Assemble PHAT
    # -------------------------
    - name: Assemble PHAT
      run: |
        set -euxo pipefail

        ROOT=$PWD
        INSTALL=$PWD/wine/build/install/usr
        PHAT=$PWD/wcp

        # каноническая PHAT‑структура
        mkdir -p $PHAT/bin \
                 $PHAT/lib/wine/aarch64-unix \
                 $PHAT/lib/wine/aarch64-windows \
                 $PHAT/lib/wine/arm64ec-windows \
                 $PHAT/share/wine

        cp -a $INSTALL/bin/wine* $PHAT/bin/
        cp -a $INSTALL/lib/wine/aarch64-unix/*so $PHAT/lib/wine/aarch64-unix/
        cp -a $INSTALL/lib/wine/aarch64-windows/*so $PHAT/lib/wine/aarch64-windows/
        cp -a $INSTALL/lib/wine/arm64ec-windows/*so $PHAT/lib/wine/arm64ec-windows/
        cp -a $INSTALL/share/wine/* $PHAT/share/wine/

        # env.sh
        cat > $PHAT/env.sh << 'EOF'
        #!/usr/bin/env bash
        export PATH="$(dirname "$0")/bin:$PATH"
        export WINEDLLPATH="$(dirname "$0")/lib/wine"
        export WINEPREFIX="${WINEPREFIX:-$PWD/prefix}"
        export WINEDEBUG="${WINEDEBUG:--all}"
        EOF
        chmod +x $PHAT/env.sh

        # info.json
        cat > $PHAT/info.json << 'EOF'
        {
          "layout":"phat",
          "archs":["aarch64-unix","aarch64-windows","arm64ec-windows"],
          "components":{"wine":true}
        }
        EOF

    # -------------------------
    # Upload results
    # -------------------------
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: wine-11.1-arm64ec-phat
        path: ./wcp
