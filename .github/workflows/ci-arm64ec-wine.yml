name: Build Wine & WCP for Winlator‚ÄëLudashi

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-arm64ec:
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º Ubuntu 24.04 ARM64 runner
    # –≠—Ç–æ –≤–∞–∂–Ω–æ, —á—Ç–æ–±—ã —Å–±–æ—Ä–∫–∞ Wine arm64ec –±—ã–ª–∞ —á–∏—Å—Ç–æ–π –∏ –Ω–∞—Ç–∏–≤–Ω–æ–π
    runs-on: ubuntu-24.04-arm
    defaults:
      run:
        shell: bash

    steps:
      ###################################################
      # 1) Checkout source
      ###################################################
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      ###################################################
      # 2) Install build dependencies
      ###################################################
      - name: Install build dependencies
        run: |
          set -euxo pipefail

          ################################################################
          # üìå Add ports.ubuntu.com for arm64 ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ,
          # –∏–Ω–∞—á–µ apt –Ω–µ –≤–∏–¥–∏—Ç dev‚Äë–ø–∞–∫–µ—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä FreeType, SDL2).
          # –ë–µ–∑ —ç—Ç–æ–≥–æ Ubuntu‚Äërunner –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç arm64‚Äëdev –ø–∞–∫–µ—Ç—ã.
          ################################################################
          sudo bash -euxo pipefail << 'EOF'
          cat << 'CONFIG' | sudo tee /etc/apt/sources.list.d/ports-arm64.list
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports noble main universe multiverse
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports noble-updates main universe multiverse
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports noble-security main universe multiverse
          CONFIG
          sudo apt update
          EOF

          ################################################################
          # üì¶ Install build essentials and dev libs
          # We include SDL2, FreeType, Vulkan, fontconfig, dbus, usb, xml, ...
          # SDL2 ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –¥–ª—è Wine UI & input handling.
          # FreeType ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —à—Ä–∏—Ñ—Ç–æ–≤.
          # Vulkan ‚Äî –Ω—É–∂–Ω–∞ –¥–ª—è Turnip / WineD3D Vulkan backend.
          ################################################################
          sudo apt install -y --no-install-recommends \
            build-essential autoconf automake libtool pkg-config \
            python3 python3-pip git gettext flex bison \
            ninja-build cmake meson \
            llvm clang lld \
            libasound2-dev libpulse-dev libv4l-dev libgl-dev \
            libx11-dev libxext-dev libxfixes-dev libxinerama-dev \
            libxi-dev libxrandr-dev libxrender-dev \
            libfontconfig-dev libfreetype-dev libgnutls28-dev \
            libdbus-1-dev libsdl2-dev \
            libjpeg-dev libpng-dev libxml2-dev libudev-dev \
            libusb-1.0-0-dev libldap2-dev \
            libvulkan-dev

          ################################################################
          # üìå Export pkg‚Äëconfig variables for arm64 ‚Äî —á—Ç–æ–±—ã configure
          # –≤–∏–¥–µ–ª *.pc —Ñ–∞–π–ª—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä freetype2, sdl2) –≤ /usr/lib/aarch64-linux-gnu
          # –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –≤—Å–µ—Ö –ª–∏–±.
          PKG_CONFIG_PATH="/usr/lib/aarch64-linux-gnu/pkgconfig:$PKG_CONFIG_PATH"
          PKG_CONFIG_LIBDIR="/usr/lib/aarch64-linux-gnu/pkgconfig"
          export PKG_CONFIG_PATH PKG_CONFIG_LIBDIR

          sudo apt clean
          sudo rm -rf /var/lib/apt/lists/*

      ###################################################
      # 3) Setup llvm‚Äëmingw cross toolchain
      ###################################################
      - name: Setup llvm‚Äëmingw
        run: |
          set -euxo pipefail
          TOOLCHAIN_VER="20260127"
          ARCHIVE="llvm-mingw-${TOOLCHAIN_VER}-ucrt-ubuntu-22.04-aarch64.tar.xz"
          wget -q "https://github.com/mstorsjo/llvm-mingw/releases/download/${TOOLCHAIN_VER}/${ARCHIVE}"
          mkdir -p llvm-mingw
          tar -xJf "$ARCHIVE" -C llvm-mingw --strip-components=1
          echo "$PWD/llvm-mingw/bin" >> "$GITHUB_PATH"

      ###################################################
      # 4) Clone Wine & patches
      ###################################################
      - name: Clone Wine & Patches
        run: |
          set -euxo pipefail
          git clone --depth 1 --branch wine-11.1 https://gitlab.winehq.org/wine/wine.git wine
          git clone --depth 1 --branch v11.1 https://github.com/wine-staging/wine-staging.git wine-staging
          git clone https://github.com/Frogging-Family/wine-tkg-git.git wine-tkg

      ###################################################
      # 5) Apply Wine‚ÄëStaging patches
      ###################################################
      - name: Apply Staging patches
        run: |
          set -euxo pipefail
          cd wine
          python3 ../wine-staging/staging/patchinstall.py DESTDIR="$(pwd)" --all
          cd ..

      ###################################################
      # 6) Generate tkg customization
      ###################################################
      - name: Generate wine‚Äëtkg customization.cfg
        run: |
          set -euxo pipefail
          mkdir -p wine/tkg-custom
          cat > wine/tkg-custom/customization.cfg << 'EOF'
          ################################################################################
          #  Winlator‚Äëoriented wine‚Äëtkg config
          ################################################################################
          _use_staging="true"
          _use_esync="true"
          _use_fsync="true"
          _use_mono="false"
          _use_gecko="false"
          _use_fullscreen_hack="true"
          _optimize_cflags="-O2"
          _optimize_cxxflags="-O2"
          _EXTERNAL_INSTALL="false"
          ################################################################################
          EOF

      ###################################################
      # 7) Build Wine with wine‚Äëtools
      ###################################################
      - name: Configure & Compile Wine
        run: |
          set -euxo pipefail
          cd wine

          ################################################################
          # ‚îÄ‚îÄ Build wine‚Äëtools locally ‚Äì –Ω—É–∂–Ω–æ –¥–ª—è cross —Å–±–æ—Ä–∫–∏ Wine
          ################################################################
          mkdir wine-tools-build
          cd wine-tools-build
          ../configure \
            --enable-tools \
            --disable-tests \
            --disable-win16 \
            --enable-archs=aarch64
          make -j"$(nproc)"
          cd ..

          ################################################################
          # ‚îÄ‚îÄ Run tkg prepare to apply tkg custom patches
          ################################################################
          bash ../wine-tkg/wine-tkg-git/wine-tkg-scripts/prepare.sh

          ################################################################
          # ‚îÄ‚îÄ Cross‚Äëcompile Wine arm64ec
          ################################################################
          mkdir build
          cd build

          export BUILD=aarch64-linux-gnu
          export HOST=aarch64-w64-mingw32
          export CC=aarch64-w64-mingw32-clang
          export CXX=aarch64-w64-mingw32-clang++
          export AR=aarch64-w64-mingw32-ar
          export LD=aarch64-w64-mingw32-lld
          export RC=aarch64-w64-mingw32-windres
          export RANLIB=aarch64-w64-mingw32-ranlib

          ../configure \
            --build="$BUILD" \
            --host="$HOST" \
            --with-mingw=clang \
            --with-wine-tools="../wine-tools-build" \
            --prefix=/usr \
            --enable-win64 \
            --enable-wow64 \
            --enable-archs=arm64ec,aarch64 \
            --disable-tests \
            --without-mono \
            --without-gecko \
            --with-freetype \
            --with-fontconfig \
            --with-alsa \
            --with-pulse \
            --with-vulkan

          make -j"$(nproc)"

      ###################################################
      # 8) Build DXVK
      ###################################################
      - name: Build DXVK
        run: |
          set -euxo pipefail
          git clone https://github.com/doitsujin/dxvk.git dxvk
          cd dxvk
          git submodule update --init --recursive
          pip3 install meson ninja
          meson setup build \
            --cross-file=../wine/build/config/meson.cross.arm64ec.ini \
            --prefix=/usr \
            -Dbuild_tests=false
          ninja -C build && ninja -C build install

      ###################################################
      # 9) Build VKD3D‚ÄëProton
      ###################################################
      - name: Build VKD3D‚ÄëProton
        run: |
          set -euxo pipefail
          git clone https://github.com/HansKristian-Work/vkd3d-proton.git vkd3d
          cd vkd3d
          git submodule update --init --recursive
          meson setup build \
            --cross-file=../wine/build/config/meson.cross.arm64ec.ini \
            --prefix=/usr \
            -Dbuild_tests=false
          ninja -C build && ninja -C build install

      ###################################################
      # 10) Build TURNIP Mesa Vulkan
      ###################################################
      - name: Build TURNIP Mesa
        run: |
          set -euxo pipefail
          git clone https://gitlab.freedesktop.org/mesa/mesa.git mesa
          cd mesa
          pip3 install meson ninja
          meson setup builddir \
            -Dvulkan-drivers=turnip \
            -Dgallium-drivers=freedreno \
            -Dplatforms=android,x11 \
            --cross-file=../wine/build/config/meson.cross.arm64ec.ini \
            -Dbuildtype=release
          ninja -C builddir && ninja -C builddir install

      ###################################################
      # 11) Packaging .wcp for Winlator
      ###################################################
      - name: Package .wcp
        run: |
          set -euxo pipefail
          cd wine/build
          DESTDIR=$PWD/install make install
          cd install
          mkdir -p wcp/{bin,lib/wine,share}

          cp -a usr/bin/* wcp/bin/ 2>/dev/null || true
          cp -a usr/lib/wine/* wcp/lib/wine/ 2>/dev/null || true
          cp -a usr/share/* wcp/share/ 2>/dev/null || true

          cd wcp/bin && ln -sf wine64 wine && cd ..

          find bin -type f -exec chmod +x {} +
          find lib -name "*.so*" -exec chmod +x {} +

          cat > profile.json << 'EOF'
          {
            "id": "wine-11.1-staging-tkg-arm64ec",
            "name": "Wine 11.1 Staging‚Äëtkg Arm64EC",
            "version": "11.1",
            "arch": "arm64ec",
            "files": {
              "bin": "bin/",
              "lib": "lib/",
              "share": "share/"
            }
          }
          EOF

          tar -cJf "$GITHUB_WORKSPACE/wine-11.1-staging-tkg-arm64ec.wcp" profile.json wcp

      ###################################################
      # 12) Upload artifact
      ###################################################
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wine-wcp-arm64ec
          path: wine-11.1-staging-tkg-arm64ec.wcp