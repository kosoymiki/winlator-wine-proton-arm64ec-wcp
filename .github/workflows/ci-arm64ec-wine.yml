name: Build Wine 11.1 Staging ARM64EC (PHAT .wcp)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-arm64ec:
    runs-on: ubuntu-24.04-arm

    env:
      WORKDIR: ${{ github.workspace }}
      WINEDIR: ${{ github.workspace }}/wine
      STAGINGDIR: ${{ github.workspace }}/wine-staging
      BUILDDIR: ${{ github.workspace }}/build/wine
      EXTERNALDIR: ${{ github.workspace }}/build/external
      WCP_DIR: ${{ github.workspace }}/wcp

      WINE_TAG: "wine-11.1"
      STAGING_TAG: "v11.1"
      LLVM_MINGW_VERSION: "20251216"
      LLVM_MINGW_DIR: ${{ github.workspace }}/toolchains/llvm-mingw

    defaults:
      run:
        shell: bash

    steps:

    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install build dependencies
      run: |
        set -euxo pipefail
        sudo apt update
        sudo apt install -y --no-install-recommends \
          build-essential wget git python3 gettext \
          pkgconf cmake ninja-build meson \
          autoconf automake libtool \
          patchutils bison flex \
          libc6-dev libfreetype-dev libfontconfig-dev \
          libsdl2-dev libpulse-dev libasound2-dev \
          libdbus-1-dev libdb-dev \
          libavcodec-dev libavformat-dev libavutil-dev libswscale-dev \
          libudev-dev ca-certificates \
          zip rsync file
        sudo ln -sf /usr/bin/pkgconf /usr/local/bin/pkg-config || true

    - name: Setup LLVM‑Mingw ARM64EC
      run: |
        set -euxo pipefail
        rm -rf "$LLVM_MINGW_DIR"
        mkdir -p "$LLVM_MINGW_DIR"
        cd "$WORKDIR"
        wget -q "https://github.com/mstorsjo/llvm-mingw/releases/download/${LLVM_MINGW_VERSION}/llvm-mingw-${LLVM_MINGW_VERSION}-ucrt-ubuntu-22.04-aarch64.tar.xz"
        tar -xJf llvm-mingw-${LLVM_MINGW_VERSION}-ucrt-ubuntu-22.04-aarch64.tar.xz -C "$LLVM_MINGW_DIR" --strip-components=1
        rm llvm-mingw-${LLVM_MINGW_VERSION}-ucrt-ubuntu-22.04-aarch64.tar.xz
        echo "$LLVM_MINGW_DIR/bin" >> "$GITHUB_PATH"

    - name: Verify cross‑compiler
      run: |
        set -euxo pipefail
        command -v aarch64-w64-mingw32-clang
        aarch64-w64-mingw32-clang --version
        echo 'int main(void){}' > /tmp/test.c
        aarch64-w64-mingw32-clang -o /tmp/test.exe /tmp/test.c -Wl,--no-undefined
        file /tmp/test.exe

    - name: Clone Wine & Wine‑Staging by tags
      run: |
        set -euxo pipefail
        rm -rf "$WINEDIR" "$STAGINGDIR"
        git clone https://gitlab.winehq.org/wine/wine.git "$WINEDIR"
        cd "$WINEDIR"
        git fetch --tags
        git checkout -qf "$WINE_TAG"

        git clone https://gitlab.winehq.org/wine/wine-staging.git "$STAGINGDIR"
        cd "$STAGINGDIR"
        git fetch --tags
        git checkout -qf "$STAGING_TAG"

    - name: Build and install wine tools (ARM64)
      run: |
        set -euxo pipefail

        cd "$WINEDIR"
        rm -rf build-tools
        mkdir -p build-tools

        # Конфиг Wine с prefix в build-tools
        ./configure \
         --prefix="/home/runner/work/wine_11.1wcp/wine_11.1wcp/wine" \
         --disable-tests \
         --disable-win16 \
         --disable-wine9x \
         --without-vulkan

        # Собираем инструменты
        make -j$(nproc) tools

        # Явно устанавливаем инструменты в prefix
        make install -C tools

        # Проверяем результат
        echo "Contents of build-tools/bin:"
        ls -l "$WINEDIR/build-tools/bin" || true


    - name: Apply staging patches
      run: |
        set -euxo pipefail
        cd "$STAGINGDIR"
        python3 staging/patchinstall.py -d "$WINEDIR" -a --no-autoconf

        cd "$WINEDIR"
        autoreconf -fiv
        ./tools/make_requests

    - name: Verify wine tools binaries
      run: |
         set -euxo pipefail

         ls -l "$WINEDIR/build-tools/bin"
         test -x "$WINEDIR/build-tools/bin/winebuild"
         test -x "$WINEDIR/build-tools/bin/wineg++"
         test -x "$WINEDIR/build-tools/bin/makedep"


    - name: Configure Wine (cross‑compile)
      run: |
        set -euxo pipefail
        export PATH="$LLVM_MINGW_DIR/bin:$PATH"

        rm -rf "$BUILDDIR"
        mkdir -p "$BUILDDIR"
        cd "$BUILDDIR"

        export CC=aarch64-w64-mingw32-clang
        export CXX=aarch64-w64-mingw32-clang++
        export AR=aarch64-w64-mingw32-ar
        export RANLIB=aarch64-w64-mingw32-ranlib
        export STRIP=aarch64-w64-mingw32-strip

        "$WINEDIR/configure" \
          --host=aarch64-w64-mingw32 \
          --with-wine-tools="$WINEDIR/build-tools/bin" \
          --enable-win64 \
          --enable-wow64 \
          --enable-archs=arm64ec,aarch64 \
          --disable-tests \
          --without-vulkan

    - name: Build Wine
      run: |
        set -euxo pipefail
        cd "$BUILDDIR"
        make -j$(nproc)
        DESTDIR="$BUILDDIR/install" make install

    - name: Build Turnip Vulkan (mesa‑tu8)
      run: |
        set -euxo pipefail
        mkdir -p "$EXTERNALDIR"
        rm -rf "$EXTERNALDIR/mesa-src" "$EXTERNALDIR/mesa-build" "$EXTERNALDIR/mesa-install"
        git clone --depth 1 https://github.com/whitebelyash/mesa-tu8 "$EXTERNALDIR/mesa-src"
        meson setup "$EXTERNALDIR/mesa-build" "$EXTERNALDIR/mesa-src" \
          -Dvulkan-drivers=turnip \
          -Dplatforms=none \
          -Dbuildtype=release
        ninja -C "$EXTERNALDIR/mesa-build"
        DESTDIR="$EXTERNALDIR/mesa-install" ninja -C "$EXTERNALDIR/mesa-build" install

    - name: Integrate DXVK/VKD3D libs
      run: |
        set -euxo pipefail
        mkdir -p "$EXTERNALDIR/dxvk" "$EXTERNALDIR/vkd3d"
        wget -q "https://github.com/Arihany/WinlatorWCPHub/releases/download/DXVK-GPLASYNC-ARM64EC/dxvk-gplasync-arm64ec-2.7.1-1.wcp" -O /tmp/dxvk.wcp
        tar -xJf /tmp/dxvk.wcp -C "$EXTERNALDIR/dxvk"
        wget -q "https://github.com/Arihany/WinlatorWCPHub/releases/download/VKD3D-PROTON-ARM64EC/vkd3d-proton-arm64ec-3.0b.wcp" -O /tmp/vkd3d.wcp
        tar -xJf /tmp/vkd3d.wcp -C "$EXTERNALDIR/vkd3d"

    - name: Unpack FEXCore runtime
      run: |
        set -euxo pipefail
        mkdir -p "$EXTERNALDIR/fexcore"
        wget -q "https://github.com/Arihany/WinlatorWCPHub/releases/download/FEXCore/FEXCore-2601.wcp" -O /tmp/FEXCore.wcp
        tar -xJf /tmp/FEXCore.wcp -C "$EXTERNALDIR/fexcore"

    - name: Assemble PHAT .wcp
      run: |
        set -euxo pipefail
        rm -rf "$WCP_DIR"
        mkdir -p "$WCP_DIR"/{bin,share/wine,dxvk/arm64ec,vkd3d/arm64ec,mesa/turnip}
        mkdir -p "$WCP_DIR/lib/wine"/{aarch64-unix,aarch64-windows,arm64ec-windows}

        cp -v "$BUILDDIR/install/bin/"{wine,wine64,wineboot,wineserver} "$WCP_DIR/bin/" || true
        rsync -a "$BUILDDIR/install/lib/" "$WCP_DIR/lib/wine/aarch64-unix/" || true
        rsync -a "$EXTERNALDIR/dxvk/" "$WCP_DIR/dxvk/arm64ec/" || true
        rsync -a "$EXTERNALDIR/vkd3d/" "$WCP_DIR/vkd3d/arm64ec/" || true
        cp -v "$EXTERNALDIR/mesa-install/usr/local/lib/"* "$WCP_DIR/mesa/turnip/" || true
        rsync -a "$EXTERNALDIR/fexcore/" "$WCP_DIR/lib/wine/arm64ec-windows/" || true

        cat > "$WCP_DIR/env.sh" <<'EOF'
        #!/bin/sh
        export WINEDEBUG=-all
        export DXVK_ASYNC=1
        export MESA_LOADER_DRIVER_OVERRIDE=turnip
        export WINEPREFIX=~/.wine
        export WINEARCH=win64
        EOF
        chmod +x "$WCP_DIR/env.sh"

        cat > "$WCP_DIR/info.json" <<EOF
        {"name":"Wine-11.1-Staging-ARM64EC","version":"$WINE_TAG","arch":"arm64ec","type":"phat"}
        EOF

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: wine-arm64ec-phat
        path: ${{ env.WCP_DIR }}
