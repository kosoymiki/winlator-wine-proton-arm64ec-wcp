name: Build Wine 11.1 ARM64 (Ludashi CMOD Standard)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build_wine_cmod:
    runs-on: ubuntu-24.04

    env:
      # LLVM 20251216 (Ubuntu 22.04 base - самая совместимая версия)
      LLVM_MINGW_URL: "https://github.com/mstorsjo/llvm-mingw/releases/download/20251216/llvm-mingw-20251216-ucrt-ubuntu-22.04-x86_64.tar.xz"
      WINE_TAG: "wine-11.1"
      STAGING_TAG: "v11.1"
      # Ссылка на FSR патч (Proton GE)
      GE_PATCH_FSR: "https://raw.githubusercontent.com/GloriousEggroll/proton-ge-custom/master/patches/wine-hotfixes/staging/proton-fshack-staging.patch"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 1. ПОДГОТОВКА РЕПОЗИТОРИЕВ (ЧИСТАЯ)
      - name: Setup Multiarch
        run: |
          sudo dpkg --add-architecture arm64
          sudo rm -f /etc/apt/sources.list
          sudo rm -rf /etc/apt/sources.list.d/*
          
          # Генерируем sources.list для AMD64 и ARM64
          echo "deb [arch=amd64] http://archive.ubuntu.com/ubuntu noble main restricted universe multiverse" | sudo tee /etc/apt/sources.list
          echo "deb [arch=amd64] http://archive.ubuntu.com/ubuntu noble-updates main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
          echo "deb [arch=amd64] http://security.ubuntu.com/ubuntu noble-security main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
          
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports noble main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports noble-updates main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports noble-security main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
          
          sudo apt-get update
          
          # Устанавливаем зависимости + build-essential
          sudo apt-get install -y \
            build-essential \
            wget curl git cmake make flex bison pkg-config python3-minimal autoconf \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            libfreetype-dev libfreetype-dev:arm64 \
            libx11-dev libx11-dev:arm64 \
            libglib2.0-dev:arm64 libxrender-dev:arm64 libxext-dev:arm64 libxi-dev:arm64 \
            libxrandr-dev:arm64 libxinerama-dev:arm64 libxcursor-dev:arm64 \
            libxcomposite-dev:arm64 libxfixes-dev:arm64 libxxf86vm-dev:arm64 \
            libvulkan-dev:arm64 libxkbcommon-dev:arm64 \
            libsdl2-dev:arm64 libudev-dev:arm64 libgstreamer1.0-dev:arm64 \
            libgnutls28-dev:arm64 libpcap-dev:arm64 libpulse-dev:arm64 \
            libdbus-1-dev:arm64 libfontconfig1-dev:arm64

      # 2. УСТАНОВКА КОМПИЛЯТОРА
      - name: Setup LLVM MinGW
        run: |
          wget -q "$LLVM_MINGW_URL" -O llvm-mingw.tar.xz
          tar xf llvm-mingw.tar.xz
          EXTRACTED_DIR=$(find . -maxdepth 1 -type d -name "llvm-mingw-*" | head -n 1)
          mv "$EXTRACTED_DIR" llvm-mingw
          echo "$PWD/llvm-mingw/bin" >> $GITHUB_PATH

      # 3. КЛОНИРОВАНИЕ ИСХОДНИКОВ
      - name: Clone Sources
        run: |
          git clone --depth 1 --branch $WINE_TAG https://gitlab.winehq.org/wine/wine.git wine-src
          git clone --depth 1 --branch $STAGING_TAG https://gitlab.winehq.org/wine/wine-staging.git wine-staging

      # 4. ПАТЧИНГ (С ИГНОРИРОВАНИЕМ ОШИБОК)
      - name: Apply Patches
        shell: bash
        run: |
          # Включаем режим "продолжать при ошибке" для патчинга
          set +e
          cd wine-staging
          
          echo ">>> Applying Staging..."
          # --no-autoconf важен, чтобы не запускать autoreconf раньше времени
          ( ./staging/patchinstall.py DESTDIR=../wine-src --all --no-autoconf ) || true
          
          cd ../wine-src
          
          echo ">>> Applying FSR Patch..."
          wget -q -O fsr.patch "$GE_PATCH_FSR"
          ( patch -p1 --fuzz=3 < fsr.patch ) || echo "WARN: FSR skipped"
          
          echo ">>> Regenerating Config..."
          ( autoreconf -fiv ) || true
          ( ./tools/make_requests ) || true
          
          # Возвращаем успешный код, чтобы CI не упал
          exit 0

      # 5. СБОРКА ИНСТРУМЕНТОВ (HOST X64)
      - name: Build Wine Tools
        run: |
          mkdir wine-tools
          cd wine-tools
          # Конфигурируем для хоста
          ../wine-src/configure --enable-win64 --with-freetype --without-wayland --without-vulkan
          
          # Собираем ВСЕ необходимые инструменты, включая install и шрифты
          make -j$(nproc) \
            tools/winebuild/winebuild \
            tools/widl/widl \
            tools/wrc/wrc \
            tools/wmc/wmc \
            tools/winegcc/winegcc \
            tools/wine/wine \
            tools/make_xftmpl \
            tools/sfnt2fon/sfnt2fon \
            tools/install

      # 6. КОНФИГУРАЦИЯ ЦЕЛИ (TARGET ARM64)
      - name: Configure Wine
        run: |
          mkdir wine-build
          cd wine-build
          
          # Используем -O2 для стабильности на Cortex-X2
          export CFLAGS="-O2 -march=armv8.2-a+fp16+dotprod -fno-plt"
          export CROSSCFLAGS="-O2 -march=armv8.2-a+fp16+dotprod -g0 -mstrict-align -Wno-error"
          export PKG_CONFIG_PATH=/usr/lib/aarch64-linux-gnu/pkgconfig
          
          ../wine-src/configure \
            --host=aarch64-linux-gnu \
            --enable-win64 \
            --without-wine \
            --with-wine-tools=../wine-tools \
            --with-mingw=clang \
            --prefix=/opt/wine-custom \
            --disable-tests \
            --with-x \
            --without-wayland \
            --with-vulkan \
            --with-freetype \
            --without-gstreamer \
            --without-cups \
            --without-sane \
            --without-oss

      # 7. СБОРКА, УСТАНОВКА И УПАКОВКА (CMOD STYLE)
      - name: Build & Package
        run: |
          cd wine-build
          
          echo ">>> Building Wine..."
          make -j$(nproc)
          
          echo ">>> Installing..."
          mkdir -p ../image
          ABS_DESTDIR=$(readlink -f ../image)
          
          # STRIP=true - обход ошибки с отсутствующим стриппером
          make install DESTDIR="$ABS_DESTDIR" STRIP=true
          
          echo ">>> Preparing CMOD Package Structure..."
          cd ../image/opt
          
          # Проверка установки
          if [ ! -d "wine-custom" ]; then
             echo "FATAL: Install failed!"
             exit 1
          fi
          
          # Имя папки внутри архива (важно для Ludashi)
          FOLDER_NAME="Wine-11.1-Staging-ARM64"
          mv wine-custom "$FOLDER_NAME"
          cd "$FOLDER_NAME"
          
          # === INFO.JSON (KIMCHI/STEVENMXZ STYLE) ===
          # arch: "x86_64" - Чтобы Winlator видел этот Wine в списке
          # variant: "staging" - Для группировки
          cat <<EOF > info.json
          {
            "name": "Wine-11.1-Staging-ARM64",
            "version": "11.1",
            "arch": "x86_64",
            "type": "wine",
            "variant": "staging",
            "author": "GitHubCI",
            "description": "Native ARM64 build. Staging + FSR. Optimized for SD 8+ Gen1."
          }
          EOF
          
          # === ENV.SH (Скрипт окружения) ===
          cat <<EOF > env.sh
          #!/bin/sh
          export WINEDEBUG="-all"
          export WINEESYNC=1
          export WINEFSYNC=1
          export WINE_FULLSCREEN_FSR=1
          export WINE_FULLSCREEN_FSR_STRENGTH=2
          EOF
          chmod +x env.sh
          
          echo ">>> Compressing to .wcp..."
          cd ../..
          # Упаковываем папку opt/Wine-11.1... так, чтобы в архиве была папка
          # Winlator ожидает: archive.tar.xz -> Folder -> bin/lib/info.json
          tar -C opt -cJf wine-11.1-staging-arm64.wcp "$FOLDER_NAME"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: wine-11.1-staging-arm64.wcp
          path: wine-11.1-staging-arm64.wcp
