name: Build Wine 11.1 Staging-TkG ARM64EC + Winlator .wcp

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-arm64ec:
    runs-on: ubuntu-24.04-arm

    defaults:
      run:
        shell: bash

    steps:

      ###################################################
      # 1) Checkout source
      ###################################################
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      ###################################################
      # 2) Install build dependencies
      ###################################################
      - name: Install build dependencies
        run: |
          set -euxo pipefail

          sudo apt update
          sudo apt install -y --no-install-recommends \
            build-essential autoconf automake libtool pkg-config \
            python3 python3-pip git gettext flex bison \
            ninja-build cmake meson \
            libasound2-dev libpulse-dev libv4l-dev \
            libx11-dev libxext-dev libxfixes-dev libxinerama-dev \
            libxi-dev libxrandr-dev libxrender-dev \
            libfontconfig-dev \
            libgnutls28-dev libdbus-1-dev libsdl2-dev \
            libjpeg-dev libpng-dev libxml2-dev \
            libudev-dev libusb-1.0-0-dev libldap2-dev \
            libxkbcommon-dev libxv-dev libxxf86vm-dev \
            libxcursor-dev libxss-dev \
            libvulkan-dev lld llvm clang \
            python3-setuptools python3-wheel
          sudo apt clean

      - name: Cross‑compile core dependencies
        run: |
          set -euxo pipefail

          PREFIX_DEPS="$PWD/deps/install"
          mkdir -p deps/build

          export TOOLCHAIN=aarch64-w64-mingw32
          export CC=${TOOLCHAIN}-clang
          export CXX=${TOOLCHAIN}-clang++
          export AR=${TOOLCHAIN}-ar
          export RANLIB=${TOOLCHAIN}-ranlib
          export WINDRES=${TOOLCHAIN}-windres
          export PKG_CONFIG_PATH="${PREFIX_DEPS}/lib/pkgconfig"
          export CFLAGS="-I${PREFIX_DEPS}/include"
          export LDFLAGS="-L${PREFIX_DEPS}/lib"

          # Build zlib
          cd deps/build
          git clone --depth 1 https://github.com/madler/zlib.git zlib
          cd zlib
          ./configure --prefix="${PREFIX_DEPS}" --static --cross-prefix=${TOOLCHAIN}- --host=${TOOLCHAIN}
          make -j$(nproc) && make install
          cd ..

          # Build libpng (depends on zlib)
          git clone --depth 1 https://github.com/glennrp/libpng.git libpng
          cd libpng
          ./configure --host=${TOOLCHAIN} --prefix="${PREFIX_DEPS}" --disable-shared --enable-static
          make -j$(nproc) && make install
          cd ..

          # Build libjpeg‑turbo
          git clone --depth 1 https://github.com/libjpeg-turbo/libjpeg-turbo.git libjpeg
          cd libjpeg
          cmake -DCMAKE_TOOLCHAIN_FILE=../your_mingw_toolchain.cmake \
                -DCMAKE_INSTALL_PREFIX="${PREFIX_DEPS}" \
                -DENABLE_SHARED=OFF -DENABLE_STATIC=ON .
          make -j$(nproc) && make install
          cd ..

          # Build freetype
          git clone --depth 1 https://git.savannah.gnu.org/git/freetype/freetype2.git freetype2
          cd freetype2
          mkdir build && cd build
          ../configure --host=${TOOLCHAIN} --prefix="${PREFIX_DEPS}" --disable-shared --enable-static
          make -j$(nproc) && make install
          cd ../..

          # Build libgnutls
          git clone --depth 1 https://gitlab.com/gnutls/gnutls.git gnutls
          cd gnutls
          ./bootstrap.sh
          ./configure --host=${TOOLCHAIN} --prefix="${PREFIX_DEPS}" --disable-doc --disable-shared --enable-static
          make -j$(nproc) && make install
          cd ../..

          echo "All dependencies cross‑compiled."

      ###################################################
      # 3) Setup llvm-mingw cross toolchain
      ###################################################
      - name: Setup llvm-mingw
        run: |
          set -euxo pipefail

          TOOLCHAIN_VER="20260127"
          FILENAME="llvm-mingw-${TOOLCHAIN_VER}-ucrt-ubuntu-22.04-aarch64.tar.xz"
          URL="https://github.com/mstorsjo/llvm-mingw/releases/download/${TOOLCHAIN_VER}/${FILENAME}"

          wget -q "$URL"
          mkdir -p llvm-mingw
          tar -xJf "$FILENAME" -C llvm-mingw --strip-components=1
          echo "$PWD/llvm-mingw/bin" >> "$GITHUB_PATH"

      ###################################################
      # 4) Clone Wine + staging + tkg patches
      ###################################################
      - name: Clone Wine & Patches
        run: |
          set -euxo pipefail
          git clone --depth 1 --branch wine-11.1 https://gitlab.winehq.org/wine/wine.git wine
          git clone --depth 1 --branch v11.1 https://github.com/wine-staging/wine-staging.git wine-staging
          git clone https://github.com/Frogging-Family/wine-tkg-git.git wine-tkg

      ###################################################
      # 5) Apply Wine-Staging patches
      ###################################################
      - name: Apply staging patches
        run: |
          set -euxo pipefail
          cd wine
          python3 ../wine-staging/staging/patchinstall.py --all --destdir="$(pwd)"
          cd ..

      ###################################################
      # 6) Apply wine‑tkg patches (with skip + minimal set + debug diffs)
      ###################################################
      - name: Apply wine‑tkg patches (advanced diagnostics)
        run: |
          set -euxo pipefail

          cd wine

          # Подготовка каталогов для логов/отклоненных/диффов
          mkdir -p rejects logs diffs

          echo "==> Applying wine‑tkg patches with diagnostics" | tee apply-patch.log

          # Абсолютный базовый путь к TKG патчам
          BASE_TKG="../wine-tkg/wine-tkg-git/wine-tkg-patches"

          # Вручную добавляем очередность основных патч‑категорий
          PATCH_ROOTS=(
            "${BASE_TKG}/mainline"
            "${BASE_TKG}/staging"
            "${BASE_TKG}/hotfixes"
            "${BASE_TKG}/misc"
            "${BASE_TKG}/proton"
            "${BASE_TKG}/community-patches"
          )

          # Список патчей, которые действительно применились
          > applied-patches.list

          # Проходим по каждой основной категории
          for root in "${PATCH_ROOTS[@]}"; do
            if [ -d "$root" ]; then
              echo "--- CATEGORY ROOT: $root" | tee -a apply-patch.log

              # Проходим рекурсивно по всем *.patch в подкаталогах
              find "$root" -type f -name "*.patch" | sort | while read -r patchfile; do
                # Пропускаем .conf — лишь патчи мы применяем
                if [[ ! "$patchfile" =~ \.patch$ ]]; then
                  continue
                fi

                echo "Processing patch: $patchfile" | tee -a apply-patch.log

                # Снимем diff до применения
                git diff > before.diff || true

                # Попытка применить патч
                patch -p1 --forward < "$patchfile" > "logs/$(basename "$patchfile").out" 2>&1 || true

                # Проверка результата
                if grep -q -E "Hunk FAILED|fail" "logs/$(basename "$patchfile").out"; then
                  echo "❗ Conflict/Fail in: $patchfile" | tee -a apply-patch.log
                  # Сохраняем reject hunks
                  if ls *.rej 1> /dev/null 2>&1; then
                    mv *.rej "rejects/$(basename "$patchfile").rej" || true
                    echo "Saved rejects for $(basename "$patchfile")" | tee -a apply-patch.log
                  fi
                else
                  echo "✅ Applied: $patchfile" | tee -a apply-patch.log
                  echo "$patchfile" >> applied-patches.list

                  # Снимаем diff после применения
                  git diff > "diffs/$(basename "$patchfile").diff" || true
                  echo "Saved diff for $(basename "$patchfile")" | tee -a apply-patch.log
                fi

              done
            else
              echo "Skipping missing category root: $root" | tee -a apply-patch.log
            fi
          done

          echo "==> Finished wine‑tkg patch application" | tee -a apply-patch.log
          cd ..

      ###################################################
      # 7) Build FreeType2 for mingw
      ###################################################
      - name: Build FreeType2 for mingw (Windows target)
        run: |
          set -euxo pipefail
          mkdir -p deps/freetype2
          cd deps/freetype2
          git clone --depth 1 https://git.savannah.gnu.org/git/freetype/freetype2.git .
          mkdir build && cd build

          export CC=aarch64-w64-mingw32-clang
          export CXX=aarch64-w64-mingw32-clang++
          export AR=aarch64-w64-mingw32-ar
          export RANLIB=aarch64-w64-mingw32-ranlib
          export WINDRES=aarch64-w64-mingw32-windres

          export PREFIX="$(pwd)/install"

          ../configure \
            --host=aarch64-w64-mingw32 \
            --prefix="$PREFIX" \
            --enable-static \
            --disable-shared

          make -j"$(nproc)"
          make install
          cd ../../../

      ###################################################
      # 8) Configure & Compile Wine
      ###################################################
      - name: Configure & Compile Wine
        run: |
          set -euxo pipefail
          cd wine

          mkdir wine-tools-build
          cd wine-tools-build
          ../configure \
            --enable-tools \
            --disable-tests \
            --disable-win16 \
            --enable-archs=aarch64
          make -j"$(nproc)"
          cd ..

          mkdir build
          cd build

          export BUILD=aarch64-linux-gnu
          export HOST=aarch64-w64-mingw32
          export CC=aarch64-w64-mingw32-clang
          export CXX=aarch64-w64-mingw32-clang++
          export AR=aarch64-w64-mingw32-ar
          export LD=aarch64-w64-mingw32-lld
          export RC=aarch64-w64-mingw32-windres
          export RANLIB=aarch64-w64-mingw32-ranlib

          export CPPFLAGS="-I$PWD/../../deps/freetype2/build/install/include"
          export LDFLAGS="-L$PWD/../../deps/freetype2/build/install/lib"

          ../configure \
            --build="$BUILD" \
            --host="$HOST" \
            --with-mingw=clang \
            --with-wine-tools="../wine-tools-build" \
            --prefix=/usr \
            --enable-win64 \
            --enable-wow64 \
            --enable-archs=arm64ec,aarch64 \
            --disable-tests \
            --without-mono \
            --without-gecko \
            --with-freetype \
            --with-fontconfig \
            --with-alsa \
            --with-pulse \
            --with-vulkan
          make -j"$(nproc)"

      ###################################################
      # 9) Build DXVK
      ###################################################
      - name: Build DXVK
        run: |
          set -euxo pipefail
          git clone https://github.com/doitsujin/dxvk.git dxvk
          cd dxvk
          git submodule update --init --recursive
          pip3 install meson ninja
          meson setup build --cross-file=../wine/build/config/meson.cross.arm64ec.ini --prefix=/usr -Dbuild_tests=false
          ninja -C build install

      ###################################################
      # 10) Build VKD3D-Proton
      ###################################################
      - name: Build VKD3D-Proton
        run: |
          set -euxo pipefail
          git clone https://github.com/HansKristian-Work/vkd3d-proton.git vkd3d
          cd vkd3d
          git submodule update --init --recursive
          meson setup build --cross-file=../wine/build/config/meson.cross.arm64ec.ini --prefix=/usr -Dbuild_tests=false
          ninja -C build install

      ###################################################
      # 11) Package .wcp
      ###################################################
      - name: Package .wcp
        run: |
          set -euxo pipefail
          cd wine/build
          DESTDIR=$PWD/install make install
          cd install

          mkdir -p wcp/{bin,lib,share}
          cp -a usr/bin/* wcp/bin/ || true
          cp -a usr/lib/wine/* wcp/lib/ || true
          cp -a usr/share/* wcp/share/ || true
          cd wcp/bin && ln -sf wine64 wine
          find . -type f -exec chmod +x {} \;

          cat > profile.json << 'EOF'
          {
            "id":"wine-11.1-staging-tkg-arm64ec",
            "name":"Wine 11.1 Staging-TkG Arm64EC",
            "version":"11.1",
            "arch":"arm64ec",
            "files":{"bin":"bin/","lib":"lib/","share":"share/"}
          }
          EOF

          tar -cJf "$GITHUB_WORKSPACE/wine-11.1-staging-tkg-arm64ec.wcp" profile.json wcp

      ###################################################
      # 12) Upload artifact
      ###################################################
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wine-arm64ec-wcp
          path: wine-11.1-staging-tkg-arm64ec.wcp
