name: Build Wine 11.1 Staging for ARM64EC (PHAT .wcp)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      WINE_VERSION: "11.1"
      LLVM_MINGW_VERSION: "20251216"
      LLVM_MINGW_DIR: "$HOME/llvm-mingw"
      BUILD_DIR: "$GITHUB_WORKSPACE/build"
      WCP_DIR: "$GITHUB_WORKSPACE/wcp"

    steps:

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Enable multi‑arch and jammy update/security repos
      run: |
        sudo dpkg --add‑architecture arm64
        # Ensure jammy, jammy‑updates and jammy‑security are enabled
        sudo sed -i '/^# jammy main/ s/^# //' /etc/apt/sources.list || true
        sudo sed -i '/^# jammy‑updates/ s/^# //' /etc/apt/sources.list || true
        sudo sed -i '/^# jammy‑security/ s/^# //' /etc/apt/sources.list || true
        # Add ports for arm64
        echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu‑ports jammy main universe multiverse restricted" | sudo tee /etc/apt/sources.list.d/ports.list
        echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu‑ports jammy‑updates main universe multiverse restricted" | sudo tee -a /etc/apt/sources.list.d/ports.list
        echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu‑ports jammy‑security main universe multiverse restricted" | sudo tee -a /etc/apt/sources.list.d/ports.list
        sudo apt update

    - name: Install cross‑compile dependencies (arm64)
      run: |
        sudo apt install -y --no-install-recommends \
          build-essential wget ca-certificates git python3 gettext \
          pkgconf cmake ninja-build autoconf automake libtool \
          libc6-dev:arm64 linux-libc-dev:arm64 \
          libfreetype-dev:arm64 libfontconfig-dev:arm64 \
          libsdl2-dev:arm64 libpulse-dev:arm64 libasound2-dev:arm64 \
          libdbus-1-dev:arm64 libdb-dev:arm64 \
          libavcodec-dev:arm64 libavformat-dev:arm64 libavutil-dev:arm64 libswscale-dev:arm64 \
          libudev-dev:arm64
        sudo apt clean

    - name: Symlink pkgconf → pkg-config
      run: |
        sudo ln -sf /usr/bin/pkgconf /usr/local/bin/pkg-config

    - name: Download & unpack LLVM‑Mingw cross toolchain
      run: |
        mkdir -p $HOME/llvm-mingw
        wget -q https://github.com/mstorsjo/llvm-mingw/releases/download/${LLVM_MINGW_VERSION}/llvm-mingw-${LLVM_MINGW_VERSION}-ucrt-ubuntu-22.04-x86_64.tar.xz
        tar -xJf llvm-mingw-${LLVM_MINGW_VERSION}-ucrt-ubuntu-22.04-x86_64.tar.xz -C $HOME/llvm-mingw --strip-components=1
        rm llvm-mingw-${LLVM_MINGW_VERSION}-ucrt-ubuntu-22.04-x86_64.tar.xz
      shell: bash

    - name: Add llvm‑mingw to PATH
      run: |
        echo "${LLVM_MINGW_DIR}/bin" >> $GITHUB_PATH

    - name: Prepare Wine sources
      run: |
        git submodule update --init --recursive
        mkdir -p wine
        if [ ! -f wine/configure ]; then
          wget -q https://dl.winehq.org/wine/source/11.1/wine-11.1.tar.xz
          tar -xJf wine-11.1.tar.xz -C wine --strip-components=1
          rm wine-11.1.tar.xz
        fi

    - name: Apply Staging patches
      run: |
        git clone https://gitlab.winehq.org/wine/wine-staging.git wine-staging
        cd wine-staging/patches
        git apply ../*.patch

    - name: Configure & Build Wine with Wow64
      run: |
        mkdir -p $BUILD_DIR
        cd $BUILD_DIR
        export PKG_CONFIG=pkg-config
        export PKG_CONFIG_PATH="/usr/lib/arm64/pkgconfig:/usr/lib/aarch64-linux-gnu/pkgconfig:${PKG_CONFIG_PATH:-}"
        export CC=aarch64-w64-mingw32-clang
        export CXX=aarch64-w64-mingw32-clang++
        export AR=aarch64-w64-mingw32-ar
        export RANLIB=aarch64-w64-mingw32-ranlib
        export STRIP=aarch64-w64-mingw32-strip
        ../wine/configure \
          --host=aarch64-w64-mingw32 \
          --with-wine-tools=../host \
          --enable-win64 \
          --enable-wow64 \
          --enable-archs=arm64ec,aarch64 \
          --disable-tests \
          --enable-ntsync \
          --without-x \
          --without-vulkan
        make -j1
        DESTDIR=$PWD/install make install

    - name: Integrate DXVK, VKD3D & Turnip
      run: |
        wget -q https://github.com/Arihany/WinlatorWCPHub/releases/download/DXVK-GPLASYNC-ARM64EC/dxvk-gplasync-arm64ec-2.7.1-1.wcp
        mkdir -p $BUILD_DIR/external/dxvk
        tar -xJf dxvk-gplasync-arm64ec-2.7.1-1.wcp -C $BUILD_DIR/external/dxvk
        wget -q https://github.com/Arihany/WinlatorWCPHub/releases/download/VKD3D-PROTON-ARM64EC/vkd3d-proton-arm64ec-3.0b.wcp
        mkdir -p $BUILD_DIR/external/vkd3d
        tar -xJf vkd3d-proton-arm64ec-3.0b.wcp -C $BUILD_DIR/external/vkd3d
        wget -q https://github.com/Arihany/WinlatorWCPHub/releases/download/MESA-TURNIP-ARM64EC/mesa-turnip-arm64ec.wcp
        mkdir -p $BUILD_DIR/external/mesa
        tar -xJf mesa-turnip-arm64ec.wcp -C $BUILD_DIR/external/mesa

    - name: Prepare PHAT .wcp tree
      run: |
        rm -rf $WCP_DIR
        mkdir -p $WCP_DIR/bin \
                 $WCP_DIR/lib/wine/aarch64-unix \
                 $WCP_DIR/lib/wine/aarch64-windows \
                 $WCP_DIR/lib/wine/arm64ec-windows \
                 $WCP_DIR/share/wine \
                 $WCP_DIR/dxvk/arm64ec \
                 $WCP_DIR/vkd3d/arm64ec \
                 $WCP_DIR/mesa/turnip

        cp -v $BUILD_DIR/install/bin/{wine,wine64,wineserver,wineboot} $WCP_DIR/bin/
        cp -rv $BUILD_DIR/install/lib/* $WCP_DIR/lib/wine/aarch64-unix/
        cp -rv $BUILD_DIR/install/lib/* $WCP_DIR/lib/wine/aarch64-windows/
        cp -rv $BUILD_DIR/install/lib/* $WCP_DIR/lib/wine/arm64ec-windows/
        cp -rv $BUILD_DIR/external/dxvk/* $WCP_DIR/dxvk/arm64ec/
        cp -rv $BUILD_DIR/external/vkd3d/* $WCP_DIR/vkd3d/arm64ec/
        cp -rv $BUILD_DIR/external/mesa/* $WCP_DIR/mesa/turnip/

        printf "export WINEPREFIX=~/.wine\nexport WINEARCH=win64\n" > $WCP_DIR/env.sh
        jq -n --arg v "$WINE_VERSION" --arg arch "arm64ec" '{version:$v,architecture:$arch,"type":"phat"}' > $WCP_DIR/info.json

    - name: Upload PHAT .wcp archive
      uses: actions/upload-artifact@v4
      with:
        name: wine-arm64ec-phat
        path: $WCP_DIR

    - name: Summary
      run: |
        echo "PHAT .wcp build completed; artifacts uploaded."
