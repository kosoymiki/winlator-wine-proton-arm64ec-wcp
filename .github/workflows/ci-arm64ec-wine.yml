name: Wine 11.1 Staging PHAT + DXVK + VKD3D ARM64EC (Fixed Path Correct)

on:
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'warning'
      tags:
        description: 'Test scenario tags'

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      # ============================================================
      # SYSTEM SETUP (Allow failures here)
      # ============================================================
      - name: System setup
        run: |
          # set +e is default behavior, we don't need it explicitly
          sudo dpkg --add-architecture arm64

          sudo tee /etc/apt/sources.list <<'EOF'
          deb [arch=amd64] http://archive.ubuntu.com/ubuntu jammy main universe multiverse
          deb [arch=amd64] http://archive.ubuntu.com/ubuntu jammy-updates main universe multiverse
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy main universe multiverse
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy-updates main universe multiverse
          EOF

          sudo apt update
          sudo apt install -y \
            build-essential git python3 \
            clang lld llvm \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            flex bison autoconf automake libtool pkg-config \
            # These are for host tools, not necessarily needed for target build
            # libx11-dev:arm64 libxrandr-dev:arm64 libxrender-dev:arm64 \
            # libxi-dev:arm64 libxinerama-dev:arm64 libxcursor-dev:arm64 \
            # libxcomposite-dev:arm64 libxfixes-dev:arm64 \
            # libxkbcommon-dev:arm64 \
            # libfreetype-dev:arm64 libfontconfig1-dev:arm64 \
            # libpulse-dev:arm64 libasound2-dev:arm64 \
            # libdbus-1-dev:arm64 libudev-dev:arm64 \
            # libvulkan-dev:arm64 libdrm-dev:arm64 \
            # libglib2.0-dev:arm64 libunwind-dev:arm64
      # ============================================================
      # LLVM MinGW
      # ============================================================
      - name: LLVM MinGW
        run: |
          set -e
          wget -qO- https://github.com/mstorsjo/llvm-mingw/releases/download/20251216/llvm-mingw-20251216-ucrt-ubuntu-22.04-x86_64.tar.xz | tar xJ
          echo "$PWD/llvm-mingw-20251216-ucrt-ubuntu-22.04-x86_64/bin" >> $GITHUB_PATH

      # ============================================================
      # SOURCES
      # ============================================================
      - name: Clone Wine + Staging
        run: |
          set -e
          git clone --depth 1 -b wine-11.1 https://gitlab.winehq.org/wine/wine.git wine
          git clone --depth 1 -b v11.1 https://gitlab.winehq.org/wine/wine-staging.git staging

      # ============================================================
      # APPLY STAGING (BEFORE autoreconf, BEFORE configure)
      # ============================================================
      - name: Apply Wine-Staging
        run: |
          set -e
          cd staging
          # Apply all staging patches but don't run autoconf
          ./staging/patchinstall.py DESTDIR=../wine --all --no-autoconf
          cd ../wine
          # Regenerate configure after patches
          autoreconf -fiv

      # ============================================================
      # HOST WINETOOLS
      # ============================================================
      - name: Build host winetools
        run: |
          set -e
          mkdir -p host
          cd host
          # Configure host tools (for Linux x86_64)
          ../wine/configure --enable-win64 --disable-tests
          make -j$(nproc) __tooldeps__

      # ============================================================
      # ARM64EC + WOW64 BUILD (CRITICAL STEP - WITH STAGING, SELECTIVE DEPS)
      # ============================================================
      - name: Build Wine ARM64EC + WoW64
        run: |
          set -e          mkdir -p build
          cd build

          # --- SETTING ENVIRONMENT VARIABLES BEFORE configure ---
          export CC=aarch64-w64-mingw32-clang
          export CXX=aarch64-w64-mingw32-clang++
          export DLLTOOL=aarch64-w64-mingw32-dlltool
          export LD=lld
          export AR=aarch64-w64-mingw32-ar
          export STRIP=aarch64-w64-mingw32-strip
          export OBJDUMP=aarch64-w64-mingw32-objdump
          export RC=aarch64-w64-mingw32-windres

          OPT="-O3 -march=armv8.2-a+fp16+dotprod"
          export CFLAGS="$OPT -Wno-error"
          export CXXFLAGS="$OPT -Wno-error"
          export PKG_CONFIG_PATH=""

          # --- CONFIGURE WITH STAGING, HOST, SELECTIVE DEPS ---
          ../wine/configure \
            --host=aarch64-w64-mingw32 \
            --with-wine-tools=../host \
            --with-mingw=clang \
            --enable-win64 \
            --enable-wow64 \
            --enable-archs=arm64ec,aarch64,i386 \
            --disable-tests \
            --without-x \
            --without-glx \
            --without-glu \
            --without-wayland \
            --without-gstreamer \
            --without-cups \
            --without-sane \
            --without-freetype \
            --without-fontconfig \
            --without-hal \
            --without-oss \
            --without-alsa \
            --without-jpeg \
            --without-tiff \
            --without-png \
            --without-gphoto \
            --without-capi \
            --without-netapi \
            --without-krb5 \
            --without-gssapi \
            --without-ldap \
            --without-mpg123 \
            --without-openal \            --without-opencl \
            --without-opengl \
            --without-vulkan

          # Check if Makefile was created AFTER configure
          if [ ! -f "Makefile" ]; then
              echo "Configure failed, no Makefile generated."
              echo "=== Contents of config.log ==="
              cat config.log || echo "config.log not found or empty."
              echo "=============================="
              exit 1 # Explicitly fail if configure fails
          else
              echo "Configure successful, Makefile exists. Starting make..."
              # Run make, and if it fails, the step will terminate with an error
              make -j$(nproc)
              echo "Build (make) successful."

              # Run make install to populate the install directory inside build
              echo "Running make install..."
              DESTDIR=$PWD/install make install
              echo "Make install completed."
          fi

      # ============================================================
      # PHAT WCP + DXVK + VKD3D INTEGRATION (CORRECTED PATH TO INSTALL)
      # ============================================================
      - name: Create PHAT WCP
        run: |
          set -e
          BUILD_DIR="$GITHUB_WORKSPACE/build"
          INSTALL_DIR="$BUILD_DIR/install"

          # Check if the 'build' directory exists
          if [ ! -d "$BUILD_DIR" ]; then
              echo "Error: Directory '$BUILD_DIR' does not exist. Previous build step likely failed."
              echo "Current working directory: $(pwd)"
              echo "Contents of workspace: $(ls -la $GITHUB_WORKSPACE)"
              exit 1
          fi

          # Change to the 'build' directory first
          cd "$BUILD_DIR"

          # Check if the 'install' directory exists inside 'build'
          if [ ! -d "$INSTALL_DIR" ]; then
              echo "Error: Directory '$INSTALL_DIR' does not exist inside '$BUILD_DIR'. Make install likely failed."
              echo "Contents of build dir: $(ls -la)"
              exit 1
          fi
          # Change to the 'install' directory (now relative to build/)
          cd install

          mkdir -p wcp/{bin,lib/wine/{aarch64-unix,aarch64-windows},share}

          # Copying core Wine files
          cp -r usr/bin/* wcp/bin/
          cd wcp/bin && ln -sf wine64 wine && cd ../.. # Creating symlink for wine

          # Copying DLL/SO files
          find usr/lib -name "*.dll.so" -exec cp {} wcp/lib/wine/aarch64-windows/ \;
          find usr/lib -name "*.exe.so" -exec cp {} wcp/lib/wine/aarch64-windows/ \;
          find usr/lib -name "*.so" ! -name "*.dll.so" -exec cp {} wcp/lib/wine/aarch64-unix/ \;

          # Copying resource files
          cp -r usr/share/wine wcp/share/
          [ -d usr/share/applications ] && cp -r usr/share/applications wcp/share/
          [ -d usr/share/man ] && cp -r usr/share/man wcp/share/

          # -------------------------------
          # DXVK WCP INTEGRATION
          # -------------------------------
          echo "Downloading DXVK WCP..."
          wget -q https://github.com/Arihany/WinlatorWCPHub/releases/download/DXVK-GPLASYNC-ARM64EC/dxvk-gplasync-arm64ec-2.7.1-1.wcp
          if [ ! -f "dxvk-gplasync-arm64ec-2.7.1-1.wcp" ]; then
              echo "Error: DXVK WCP download failed or file not found."
              exit 1
          fi
          mkdir -p temp_dxvk
          tar -xJf dxvk-gplasync-arm64ec-2.7.1-1.wcp -C temp_dxvk
          # Copy DXVK contents into the main wcp
          cp -r temp_dxvk/wcp/* wcp/
          rm -rf temp_dxvk

          # -------------------------------
          # VKD3D WCP INTEGRATION
          # -------------------------------
          echo "Downloading VKD3D WCP..."
          wget -q https://github.com/Arihany/WinlatorWCPHub/releases/download/VKD3D-PROTON-ARM64EC/vkd3d-proton-arm64ec-3.0b.wcp
          if [ ! -f "vkd3d-proton-arm64ec-3.0b.wcp" ]; then
              echo "Error: VKD3D WCP download failed or file not found."
              exit 1
          fi
          mkdir -p temp_vkd3d
          tar -xJf vkd3d-proton-arm64ec-3.0b.wcp -C temp_vkd3d
          # Copy VKD3D contents into the main wcp
          cp -r temp_vkd3d/wcp/* wcp/
          rm -rf temp_vkd3d

          # -------------------------------          # CREATE env.sh and info.json
          # -------------------------------
          # cat command has 10 space indent
          cat > wcp/env.sh << 'EOF'
          #!/bin/sh
          export WINEDEBUG=-all
          export WINEESYNC=1
          export WINEFSYNC=1
          export WINEARCH=win64
          export DXVK_ASYNC=1
          export MESA_LOADER_DRIVER_OVERRIDE=turnip
          EOF
          # chmod command has 10 space indent
          chmod +x wcp/env.sh

          # cat command has 10 space indent
          cat > wcp/info.json << 'EOF'
          {
            "name": "Wine-11.1-Staging-PHAT-DXVK-VKD3D-ARM64EC",
            "version": "11.1",
            "arch": "arm64",
            "variant": "winlator-ultimate-arm64ec"
          }
          EOF
          # chmod command has 10 space indent
          chmod +x wcp/info.json

          # -------------------------------
          # PACKAGE FINAL WCP
          # -------------------------------
          echo "Creating final WCP archive..."
          tar -cJf $GITHUB_WORKSPACE/wine-11.1-staging-phat-dxvk-vkd3d-arm64ec.wcp -C wcp

          echo "Final WCP created:"
          ls -lh $GITHUB_WORKSPACE/*.wcp

      # ============================================================
      # UPLOAD ARTIFACT (Only run if previous steps succeeded)
      # ============================================================
      - name: Upload WCP Artifact
        uses: actions/upload-artifact@v4
        with:
          name: wine-11.1-staging-phat-dxvk-vkd3d-arm64ec
          path: wine-11.1-staging-phat-dxvk-vkd3d-arm64ec.wcp
