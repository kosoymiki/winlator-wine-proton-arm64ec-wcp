name: Build Wine 11.1 ARM64EC PHAT

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      MAKEFLAGS: -j$(nproc)

    steps:

    - name: Checkout repository
      uses: actions/checkout@v4

    # -----------------------------
    # System setup
    # -----------------------------
    - name: System setup (stable, jammy, ARM64EC)
      run: |
        set -euxo pipefail

        # enable i386 architecture for multiarch
        sudo dpkg --add-architecture i386 || true
        sudo apt-get update

        # pkgconf is sufficient for pkg‑config functionality
        sudo apt-get install -y --no-install-recommends pkgconf

        # core build dependencies
        sudo apt-get install -y --no-install-recommends \
          build-essential git python3 ca-certificates \
          clang lld llvm \
          gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
          flex bison autoconf automake libtool

        # X11 / Vulkan / DRM headers
        sudo apt-get install -y --no-install-recommends \
          libx11-dev libxext-dev libxrandr-dev libxrender-dev \
          libxi-dev libxinerama-dev libxcursor-dev \
          libxcomposite-dev libxfixes-dev libxkbcommon-dev \
          libdrm-dev libvulkan-dev

        # sound / dbus / SDL2
        sudo apt-get install -y --no-install-recommends \
          libpulse-dev libasound2-dev \
          libdbus-1-dev \
          libsdl2-dev

        # multimedia (FFmpeg)
        sudo apt-get install -y --no-install-recommends \
          libavcodec-dev libavformat-dev libavutil-dev libswscale-dev

        # misc support
        sudo apt-get install -y --no-install-recommends \
          inotify-tools libinotifytools0-dev \
          libpcsclite-dev \
          gettext

        # FreeType dev for UI text rendering (amd64 + i386)
        sudo apt-get install -y --no-install-recommends \
          libfreetype6-dev \
          libfreetype6-dev:i386

        # Make sure FreeType headers are discoverable
        sudo ln -sf /usr/include/freetype2 /usr/include/freetype

        sudo apt-get update

    # -----------------------------
    # LLVM MinGW (for cross‑tools)
    # -----------------------------
    - name: LLVM MinGW
      run: |
        wget -qO llvm-mingw.tar.xz \
          https://github.com/mstorsjo/llvm-mingw/releases/download/20251216/llvm-mingw-20251216-ucrt-ubuntu-22.04-x86_64.tar.xz
        tar -xJf llvm-mingw.tar.xz
        echo "$PWD/llvm-mingw-20251216-ucrt-ubuntu-22.04-x86_64/bin" >> $GITHUB_PATH

    # -----------------------------
    # Get Wine and Staging
    # -----------------------------
    - name: Clone Wine + Wine‑Staging
      run: |
        git clone --depth 1 -b wine-11.1 https://gitlab.winehq.org/wine/wine.git wine
        git clone --depth 1 -b v11.1 https://gitlab.winehq.org/wine/wine-staging.git staging

    # -----------------------------
    # Apply Wine‑Staging patches
    # -----------------------------
    - name: Apply Wine‑Staging patches
      run: |
        cd staging
        ./staging/patchinstall.py DESTDIR=../wine --all --no-autoconf
        cd ../wine
        autoreconf -fiv

    # -----------------------------
    # Build host tools
    # -----------------------------
    - name: Build host winetools
      run: |
        mkdir host && cd host
        ../wine/configure --enable-win64 --disable-tests
        make __tooldeps__

    # -----------------------------
    # Configure & Build Wine
    # -----------------------------
    - name: Configure & Build Wine
      run: |
          set -euxo pipefail

          mkdir -p build
          cd build

          # Пути к Linux‑sysroot (для заголовков glibc aarch64‑linux)
          export SYSROOT="/usr/aarch64-linux-gnu"
          export HOST_TRIPLET="aarch64-w64-mingw32"

          # Пробрасываем include/lib пути для sys/inotify.h и других glibc API
          export CPPFLAGS="-I${SYSROOT}/include -I/usr/include/freetype2 ${CPPFLAGS:-}"
          export LDFLAGS="-L${SYSROOT}/lib ${LDFLAGS:-}"
          export PKG_CONFIG=pkgconf

          ../wine/configure \
            --host=${HOST_TRIPLET} \
            --with-wine-tools=../host \
            --enable-win64 \
            --enable-wow64 \
            --enable-archs=arm64ec,aarch64 \
            --disable-tests \
            --with-freetype \
            --with-fontconfig \
            --with-sdl2 \
            --with-alsa \
            --with-pulse \
            --with-db \
            --with-inotify \
            --without-pcap \
            --with-ffmpeg

          make -j$(nproc)
          DESTDIR=$PWD/install make install


    # -----------------------------
    # Create PHAT WCP structure
    # -----------------------------
    - name: Create PHAT structure
      run: |
        set -euxo pipefail

        WINE_INSTALL="$PWD/build/install/usr"
        PHAT="$PWD/build/install/wcp"
        mkdir -p "$PHAT"

        # bin/
        mkdir -p "$PHAT/bin"
        cp "$WINE_INSTALL/bin/wine" "$PHAT/bin/"
        cp "$WINE_INSTALL/bin/wine64" "$PHAT/bin/"
        cp "$WINE_INSTALL/bin/wineserver" "$PHAT/bin/"
        cp "$WINE_INSTALL/bin/wineboot" "$PHAT/bin/"

        # lib/wine/
        mkdir -p "$PHAT/lib/wine/aarch64-unix"
        mkdir -p "$PHAT/lib/wine/aarch64-windows"
        mkdir -p "$PHAT/lib/wine/arm64ec-windows"

        find "$WINE_INSTALL/lib" -type f -name "*.so" ! -name "*.dll.so" \
          -exec cp {} "$PHAT/lib/wine/aarch64-unix/" \;

        find "$WINE_INSTALL/lib" -type f -name "*.dll.so" \
          -exec cp {} "$PHAT/lib/wine/aarch64-windows/" \;

        find "$WINE_INSTALL/lib/arm64ec-windows" -type f -name "*.dll.so" \
          -exec cp {} "$PHAT/lib/wine/arm64ec-windows/" \;

        # share/
        mkdir -p "$PHAT/share/wine"
        cp -a "$WINE_INSTALL/share/wine/." "$PHAT/share/wine/"

        # dxvk
        mkdir -p "$PHAT/dxvk/arm64ec"
        if [ -d "$PWD/dxvk.wcp/arm64ec" ]; then
          cp -a "$PWD/dxvk.wcp/arm64ec/." "$PHAT/dxvk/arm64ec/"
        fi

        # vkd3d
        mkdir -p "$PHAT/vkd3d/arm64ec"
        if [ -d "$PWD/vkd3d.wcp/arm64ec" ]; then
          cp -a "$PWD/vkd3d.wcp/arm64ec/." "$PHAT/vkd3d/arm64ec/"
        fi

        # mesa / turnip
        mkdir -p "$PHAT/mesa/turnip"
        if [ -d "$PWD/turnip/mesa/turnip" ]; then
          cp -a "$PWD/turnip/mesa/turnip/." "$PHAT/mesa/turnip/"
        fi

        # env.sh
        cat > "$PHAT/env.sh" << 'EOF'
        #!/bin/sh
        export WINEDEBUG=-all
        export WINE_NTSYNC=1
        export WINEESYNC=0
        export WINEFSYNC=0
        EOF
        chmod +x "$PHAT/env.sh"

        # info.json
        cat > "$PHAT/info.json" << 'EOF'
        {
          "name": "Wine 11.1 ARM64EC PHAT",
          "version": "11.1",
          "build": "PHAT",
          "arch": "arm64ec",
          "components": {
            "wine": true,
            "dxvk": true,
            "vkd3d": true,
            "turnip": true
          }
        }
        EOF

        test -d "$PHAT/lib/wine/arm64ec-windows" || (echo "Missing arm64ec-windows libs!" && exit 1)

        tar -cJf "$GITHUB_WORKSPACE/wine-11.1-arm64ec-phat.wcp" -C "$PHAT" .

    # -----------------------------
    # Upload artifact
    # -----------------------------
    - name: Upload Wine artifact
      uses: actions/upload-artifact@v4
      with:
        name: wine-11.1-arm64ec-phat
        path: ./wine-11.1-arm64ec-phat.wcp
