name: Build Wine 11.1 ARM64EC PHAT

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      MAKEFLAGS: -j$(nproc)

    steps:

    - name: Checkout repository
      uses: actions/checkout@v4

    # -----------------------------
    # System setup
    # -----------------------------
    - name: System setup (stable, jammy, ARM64EC)
      run: |
        set -euxo pipefail

        # поддержка разных архитектур
        sudo dpkg --add-architecture i386 || true
        sudo dpkg --add-architecture arm64 || true
        sudo apt-get update

        sudo apt-get install -y --no-install-recommends pkgconf

        sudo apt-get install -y --no-install-recommends \
          build-essential git python3 ca-certificates \
          clang lld llvm \
          flex bison autoconf automake libtool \
          gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

        sudo apt-get install -y --no-install-recommends \
          libx11-dev libxext-dev libxrandr-dev libxrender-dev \
          libxi-dev libxinerama-dev libxcursor-dev \
          libxcomposite-dev libxfixes-dev libxkbcommon-dev \
          libdrm-dev libvulkan-dev

        sudo apt-get install -y --no-install-recommends \
          libpulse-dev libasound2-dev \
          libdbus-1-dev libsdl2-dev

        sudo apt-get install -y --no-install-recommends \
          libavcodec-dev libavformat-dev libavutil-dev libswscale-dev

        sudo apt-get install -y --no-install-recommends \
          inotify-tools libinotifytools0-dev \
          libpcsclite-dev gettext

        # FreeType dev для ARM64, i386
        sudo apt-get install -y --no-install-recommends \
          libfreetype6-dev:arm64 \
          libfreetype6-dev \
          libfreetype6-dev:i386

        sudo apt-get update

    # -----------------------------
    # LLVM MinGW (cross‑tools)
    # -----------------------------
    - name: LLVM MinGW
      run: |
        wget -qO llvm-mingw.tar.xz \
          https://github.com/mstorsjo/llvm-mingw/releases/download/20251216/llvm-mingw-20251216-ucrt-ubuntu-22.04-x86_64.tar.xz
        tar -xJf llvm-mingw.tar.xz
        echo "$PWD/llvm-mingw-20251216-ucrt-ubuntu-22.04-x86_64/bin" >> $GITHUB_PATH

    # -----------------------------
    # Clone Wine + Wine‑Staging
    # -----------------------------
    - name: Clone Wine + Wine‑Staging
      run: |
        git clone --depth 1 -b wine-11.1 https://gitlab.winehq.org/wine/wine.git wine
        git clone --depth 1 -b v11.1 https://gitlab.winehq.org/wine/wine-staging.git staging

    # -----------------------------
    # Apply Wine‑Staging patches
    # -----------------------------
    - name: Apply Wine‑Staging patches
      run: |
        cd staging
        ./staging/patchinstall.py DESTDIR=../wine --all --no-autoconf
        cd ../wine
        autoreconf -fiv

    # -----------------------------
    # Build host tools
    # -----------------------------
    - name: Build host winetools
      run: |
        mkdir host && cd host
        ../wine/configure --enable-win64 --disable-tests
        make __tooldeps__

    # -----------------------------
    # Configure & Build Wine
    # -----------------------------
    - name: Configure & Build Wine
      run: |
        set -euxo pipefail

        mkdir -p build
        cd build

        export SYSROOT="/usr/aarch64-linux-gnu"
        export HOST_TRIPLET="aarch64-linux-gnu"

        # pkg-config для ARM64
        export PKG_CONFIG=pkgconf
        export PKG_CONFIG_LIBDIR="/usr/lib/aarch64-linux-gnu/pkgconfig:/usr/lib/pkgconfig"
        export PKG_CONFIG_SYSROOT_DIR="/"

        export CPPFLAGS="-I${SYSROOT}/include ${CPPFLAGS:-}"
        export LDFLAGS="-L${SYSROOT}/lib ${LDFLAGS:-}"

        ../wine/configure \
          --host=${HOST_TRIPLET} \
          --with-wine-tools=../host \
          --with-mingw=clang \
          --enable-win64 \
          --enable-wow64 \
          --enable-archs=arm64ec,aarch64 \
          --disable-tests \
          --with-freetype \
          --with-fontconfig \
          --with-sdl2 \
          --with-alsa \
          --with-pulse \
          --with-db \
          --with-inotify \
          --without-pcap \
          --with-ffmpeg

        make -j$(nproc)
        DESTDIR=$PWD/install make install

    # -----------------------------
    # Create PHAT WCP
    # -----------------------------
    - name: Create PHAT structure
      run: |
        set -euxo pipefail

        WINE_INSTALL="$PWD/build/install/usr"
        PHAT="$PWD/build/install/wcp"
        mkdir -p "$PHAT"

        mkdir -p "$PHAT/bin"
        cp "$WINE_INSTALL/bin/wine" "$PHAT/bin/"
        cp "$WINE_INSTALL/bin/wine64" "$PHAT/bin/"
        cp "$WINE_INSTALL/bin/wineserver" "$PHAT/bin/"
        cp "$WINE_INSTALL/bin/wineboot" "$PHAT/bin/"

        mkdir -p "$PHAT/lib/wine/aarch64-unix"
        mkdir -p "$PHAT/lib/wine/aarch64-windows"
        mkdir -p "$PHAT/lib/wine/arm64ec-windows"

        find "$WINE_INSTALL/lib" -type f -name "*.so" ! -name "*.dll.so" \
          -exec cp {} "$PHAT/lib/wine/aarch64-unix/" \;

        find "$WINE_INSTALL/lib" -type f -name "*.dll.so" \
          -exec cp {} "$PHAT/lib/wine/aarch64-windows/" \;

        find "$WINE_INSTALL/lib/arm64ec-windows" -type f -name "*.dll.so" \
          -exec cp {} "$PHAT/lib/wine/arm64ec-windows/" \;

        mkdir -p "$PHAT/share/wine"
        cp -a "$WINE_INSTALL/share/wine/." "$PHAT/share/wine/"

        cat > "$PHAT/env.sh" << 'EOF'
        #!/bin/sh
        export WINEDEBUG=-all
        export WINE_NTSYNC=1
        export WINEESYNC=0
        export WINEFSYNC=0
        EOF
        chmod +x "$PHAT/env.sh"

        cat > "$PHAT/info.json" << 'EOF'
        {
          "name": "Wine 11.1 ARM64EC PHAT",
          "version": "11.1",
          "build": "PHAT",
          "arch": "arm64ec",
          "components": {
            "wine": true,
            "dxvk": true,
            "vkd3d": true,
            "turnip": true
          }
        }
        EOF

        tar -cJf "$GITHUB_WORKSPACE/wine-11.1-arm64ec-phat.wcp" -C "$PHAT" .

    - name: Upload Wine artifact
      uses: actions/upload-artifact@v4
      with:
        name: wine-11.1-arm64ec-phat
        path: ./wine-11.1-arm64ec-phat.wcp
