name: Build Wine-TKG ARM64EC

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    env:
      WCP_NAME: wine-11.1-staging-tkg-arm64ec

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Enable multilib repository
        run: |
          sed -Ei '/^#\s*\[multilib\]/{s/^#//;n;s/^#//;}' /etc/pacman.conf
          pacman -Syy --noconfirm

      - name: Install dependencies
        run: |
          pacman -Sy --noconfirm \
            base-devel git wget unzip \
            clang lld mingw-w64-gcc \
            cmake ninja pkgconf python \
            vulkan-icd-loader \
            freetype2 \
            libx11 \
            libpulse \
            gtk3 \
            libpng \
            giflib \
            openal \
            gnutls \
            libxslt \
            sqlite \
            libjpeg-turbo \
            lib32-freetype2 \
            lib32-libx11 \
            lib32-libpng \
            lib32-giflib \
            lib32-openal \
            lib32-gnutls \
            lib32-sqlite \
            lib32-libjpeg-turbo \
            lib32-libxslt \
            lib32-fontconfig \
            lib32-mesa

      - name: Download llvmâ€‘mingw toolchain
        run: |
          wget https://github.com/mstorsjo/llvm-mingw/releases/download/20251216/llvm-mingw-20251216-ucrt-x86_64.zip
          unzip llvm-mingw-20251216-ucrt-x86_64.zip -d llvm-mingw
          echo "LLVM_MINGW=$(pwd)/llvm-mingw" >> $GITHUB_ENV

      - name: Prepare and build
        run: |
          chmod +x ./build.sh
          ./build.sh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.WCP_NAME }}
          path: "*.wcp"