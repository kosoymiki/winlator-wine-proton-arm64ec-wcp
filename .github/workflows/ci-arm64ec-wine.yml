name: Build Wine ARM64EC (AndreRH fork)

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  build-arm64ec:
    runs-on: ubuntu-latest

    container:
      image: archlinux:latest

    env:
      WCP_NAME: wine-arm64ec-andrerh
      LLVM_MINGW_VER: "20260127"
      LLVM_MINGW_URL: https://github.com/mstorsjo/llvm-mingw/releases/download/${{ env.LLVM_MINGW_VER }}/llvm-mingw-${{ env.LLVM_MINGW_VER }}-ucrt-x86_64.tar.xz

    steps:

    - name: Sync time (pacman)
      run: pacman -Sy --noconfirm

    - name: Install Arch build dependencies
      run: |
        pacman -Sy --noconfirm \
          base-devel git wget unzip \
          clang lld cmake ninja pkgconf python \
          vulkan-icd-loader \
          freetype2 \
          libx11 \
          libpulse \
          gtk3 \
          libpng \
          giflib \
          openal \
          gnutls \
          libxslt \
          sqlite \
          libjpeg-turbo \
          opencl-icd-loader \
          v4l-utils \
          libxrandr \
          libxcursor \
          libxinerama \
          alsa-lib \
          alsa-plugins \
          gst-plugins-base-libs

    - name: Fetch LLVMâ€‘Mingw
      run: |
        wget $LLVM_MINGW_URL -O llvm-mingw.tar.xz
        tar -xf llvm-mingw.tar.xz -C /opt
        export PATH="/opt/llvm-mingw-${LLVM_MINGW_VER}-ucrt/bin:$PATH"

    - name: Checkout AndreRH arm64ec Wine
      run: |
        git clone https://github.com/AndreRH/wine.git wine-anfork
        cd wine-anfork
        git checkout arm64ec

    - name: Download fresh config.sub/config.guess
      run: |
        wget https://pastebin.com/raw/2Wbtmybz -O wine-anfork/config.sub
        wget https://pastebin.com/raw/e155AbHi -O wine-anfork/config.guess

    - name: Prepare build directory
      run: |
        mkdir -p wine-build
        cd wine-build

    - name: Run build script
      run: |
        chmod +x $GITHUB_WORKSPACE/build.sh
        bash $GITHUB_WORKSPACE/build.sh

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.WCP_NAME }}
        path: "*.wcp"