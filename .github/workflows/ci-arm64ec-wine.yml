name: Build Wine 11.1 Staging‑TkG ARM64EC (FEXCore + esync/fsync)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-arm64ec:
    runs-on: ubuntu-24.04-arm

    defaults:
      run:
        shell: bash

    steps:
    # 1) Checkout
    - name: Checkout source
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # 2) Install build deps
    - name: Install build dependencies
      run: |
        set -euxo pipefail
        sudo apt update
        sudo apt install -y --no-install-recommends \
          build-essential git wget curl python3 python3-pip perl gettext \
          pkgconf cmake ninja-build meson autoconf automake libtool \
          patchutils bison flex libc6-dev linux-libc-dev \
          libfreetype-dev libfontconfig-dev libdbus-1-dev \
          libx11-dev libxext-dev libxrender-dev libxrandr-dev \
          libxinerama-dev libxcursor-dev libxi-dev libxfixes-dev \
          libsdl2-dev libpulse-dev libasound2-dev libudev-dev \
          libgl-dev libusb-1.0-0-dev libv4l-dev libpcap-dev \
          libpcsclite-dev libkrb5-dev libcups2-dev libgnutls28-dev \
          libsane-dev rsync file zip xz-utils unzip python3-setuptools

    # 3) Setup llvm‑mingw
    - name: Setup llvm‑mingw
      run: |
        set -euxo pipefail
        ROOT="$(pwd)"
        VERSION="20251216"
        ASSET="llvm-mingw-${VERSION}-ucrt-ubuntu-22.04-aarch64.tar.xz"
        URL="https://github.com/mstorsjo/llvm-mingw/releases/download/${VERSION}/${ASSET}"
        mkdir -p llvm-mingw
        wget -q "$URL" -O "$ASSET"
        tar -xJf "$ASSET" -C llvm-mingw --strip-components=1
        rm -f "$ASSET"
        echo "$ROOT/llvm-mingw/bin" >> "$GITHUB_PATH"

    # 4) Clone Wine mainline and wine‑staging
    - name: Clone Wine & staging
      run: |
        set -euxo pipefail
        git clone --depth 1 --branch wine-11.1 https://gitlab.winehq.org/wine/wine.git wine
        git clone --depth 1 --branch v11.1 https://github.com/wine-staging/wine-staging.git wine-staging

    # 5) Apply wine‑staging patchset
    - name: Apply wine‑staging patchset
      run: |
        set -euxo pipefail
        cd wine

        excludes=""
        for f in ../wine-staging/patches/*.patch; do
          fname="$(basename "$f")"
          case "$fname" in
            *ntsync*|*Syscall_Emulation*|*proton*|*winepulse*|*winealsa*)
              excludes="$excludes -W $fname"
              echo "Excluding staging patch: $fname"
              ;;
          esac
        done

        if [[ -f ../wine-staging/staging/patchinstall.py ]]; then
          python3 ../wine-staging/staging/patchinstall.py --all $excludes --destdir="$(pwd)"
        else
          echo "ERROR: patchinstall.py not found!"
          exit 1
        fi

        cd ..

    # 6) Apply wine‑tkg & community patches
    - name: Apply wine‑tkg & community patches
      run: |
        set -euxo pipefail
        cd wine

        git clone https://github.com/Frogging-Family/wine-tkg-git.git wine-tkg-src || true
        git clone https://github.com/openglfreak/wine-tkg-userpatches.git wine-userpatches-src || true
        git clone https://github.com/Frogging-Family/community-patches.git community-patches-src || true

        if [[ -d wine-tkg-src/wine-tkg-git/wine-tkg-patches/esync-fsync ]]; then
          for P in wine-tkg-src/wine-tkg-git/wine-tkg-patches/esync-fsync/*.patch; do
            [[ -f "$P" ]] || continue
            echo "Applying esync/fsync patch: $P"
            patch -p1 < "$P" || true
          done
        fi

        if [[ -d wine-tkg-src/wine-tkg-git/wine-tkg-patches/general ]]; then
          for P in wine-tkg-src/wine-tkg-git/wine-tkg-patches/general/*.patch; do
            [[ -f "$P" ]] || continue
            [[ "$P" == *ntsync* ]] && continue
            [[ "$P" == *proton* ]] && continue
            echo "Applying general tkg patch: $P"
            patch -p1 < "$P" || true
          done
        fi

        if [[ -d wine-tkg-src/wine-tkg-git/wine-tkg-patches/misc ]]; then
          for P in wine-tkg-src/wine-tkg-git/wine-tkg-patches/misc/*.patch; do
            [[ -f "$P" ]] || continue
            [[ "$P" == *ntsync* ]] && continue
            [[ "$P" == *proton* ]] && continue
            echo "Applying misc tkg patch: $P"
            patch -p1 < "$P" || true
          done
        fi

        if [[ -f wine-tkg-src/wine-tkg-git/wine-tkg-staging.patch ]]; then
          patch -p1 < wine-tkg-src/wine-tkg-git/wine-tkg-staging.patch || true
        fi

        if [[ -d wine-userpatches-src/patches ]]; then
          for P in wine-userpatches-src/patches/*.patch; do
            [[ -f "$P" ]] || continue
            [[ "$P" == *ntsync* ]] && continue
            [[ "$P" == *proton* ]] && continue
            patch -p1 < "$P" || true
          done
        fi

        apply_dir() {
          local DIR="$1"
          if [[ -d "$DIR" ]]; then
            for P in "$DIR"/*.patch; do
              [[ -f "$P" ]] || continue
              [[ "$P" == *ntsync* ]] && continue
              [[ "$P" == *proton* ]] && continue
              patch -p1 < "$P" || true
            done
          fi
        }
        apply_dir "community-patches-src/wine-tkg-git"
        apply_dir "community-patches-src/wine"
        cd ..

    # 7) Prepare Wine build system
    - name: Prepare build
      run: |
        set -euxo pipefail
        cd wine
        dlls/winevulkan/make_vulkan
        tools/make_requests
        tools/make_specfiles
        autoreconf -f
        cd ..

    # 8) Build wine tools (fixed)
    - name: Build wine tools
      run: |
        set -euxo pipefail
        mkdir wine-tools-build
        cd wine-tools-build
        ../wine/configure \
          --enable-tools --disable-tests --disable-win16 --enable-archs=aarch64,i386
        make -j"$(nproc)"
        mkdir -p ../wine-tools

        if [[ -f tools/winebuild/winebuild ]]; then cp tools/winebuild/winebuild ../wine-tools/; fi
        if [[ -f tools/widl/widl ]]; then cp tools/widl/widl ../wine-tools/; fi
        if [[ -f tools/wrc/wrc ]]; then cp tools/wrc/wrc ../wine-tools/; fi
        if [[ -f tools/wmc/wmc ]]; then cp tools/wmc/wmc ../wine-tools/; fi

        if [[ -f tools/makedep/makedep ]]; then
          cp tools/makedep/makedep ../wine-tools/
        elif [[ -f makedep ]]; then
          cp makedep ../wine-tools/
        else
          echo "No makedep found — skipping"
        fi

        cd ..

    # 9) Configure Wine cross‑compile (fixed ARM64EC toolchain)
    - name: Configure Wine cross‑compile
      run: |
        set -euxo pipefail

        export PATH="$PWD/llvm-mingw/bin:$PATH"

        mkdir wine-cross && cd wine-cross

        export BUILD=aarch64-linux-gnu
        # use aarch64-w64-mingw32 tools from llvm-mingw
        export HOST=aarch64-w64-mingw32
        export CC=aarch64-w64-mingw32-clang
        export CXX=aarch64-w64-mingw32-clang++
        export AR=aarch64-w64-mingw32-ar
        export RANLIB=aarch64-w64-mingw32-ranlib
        export LD=aarch64-w64-mingw32-lld
        export RC=aarch64-w64-mingw32-windres

        # configure Wine for ARM64EC + aarch64 + i386
        ../wine/configure \
        --build=$BUILD \
        --host=$HOST \
        --with-mingw=clang \
        --with-wine-tools="$PWD/../wine-tools" \
        --prefix=/usr \
        --enable-win64 \
        --enable-wow64 \
        --enable-archs=arm64ec,aarch64,i386 \
        --disable-tests \
        --with-freetype \
        --with-fontconfig \
        --with-dbus \
        --with-alsa \
        --with-pulse

    # 10) Build Wine
    - name: Build Wine
      run: |
        set -euxo pipefail
        cd wine-cross
        make -j"$(nproc)"

    # 11) Install Wine
    - name: Install Wine
      run: |
        set -euxo pipefail
        cd wine-cross
        DESTDIR="$PWD/install" make install

    # 12) Download external libs
    - name: Download WCP extras
      run: |
        set -euxo pipefail
        mkdir -p wcp_extra
        wget -q https://github.com/Arihany/WinlatorWCPHub/releases/download/FEXCore/FEXCore-2601.wcp -O wcp_extra/FEXCore.wcp
        wget -q https://github.com/Arihany/WinlatorWCPHub/releases/download/DXVK-GPLASYNC-ARM64EC/dxvk-gplasync-arm64ec-2.7.1-1.wcp -O wcp_extra/DXVK.wcp
        wget -q https://github.com/Arihany/WinlatorWCPHub/releases/download/VKD3D-PROTON-ARM64EC/vkd3d-proton-arm64ec-3.0b.wcp -O wcp_extra/VKD3D.wcp
        wget -q https://github.com/StevenMXZ/freedreno_turnip-CI/releases/download/v26.1/Turnip_v26.1.0.zip -O wcp_extra/Turnip.zip

    # 13) Package WCP
    - name: Package WCP
      run: |
        set -euxo pipefail
        cd wine-cross
        DESTDIR="$PWD/install" make install
        cd install
        mkdir -p wcp/{bin,lib/wine/aarch64-windows,lib/wine/aarch64-unix,share}
        cp -a usr/local/bin/* wcp/bin/
        cd wcp/bin && ln -sf wine64 wine
        cd ..
        cp -a usr/local/lib/wine/*.dll wcp/lib/wine/aarch64-windows/
        cp -a usr/local/lib/wine/*.so* wcp/lib/wine/aarch64-unix/
        for P in ../wcp_extra/*; do
          mkdir /tmp/unp
          if [[ "$P" == *.zip ]]; then unzip -q "$P" -d /tmp/unp; else tar -xJf "$P" -C /tmp/unp; fi
          cp -a /tmp/unp/* wcp/
          rm -rf /tmp/unp
        done
        cat > wcp/profile.json << "EOF"
        {
          "name": "wine-11.1-staging-tkg-arm64ec",
          "displayName": "Wine 11.1 Staging‑TkG ARM64EC (FEXCore + esync/fsync)",
          "version": "11.1",
          "arch": "arm64",
          "features": ["staging","tkg","esync","fsync","vulkan","dxvk","vkd3d"],
          "paths": {"bin":"bin/","lib":"lib/wine/","share":"share/"}
        }
        EOF
        cat > wcp/env.sh << "EOF"
        #!/bin/sh
        export WINEDEBUG=-all
        export WINEESYNC=1
        export WINEFSYNC=1
        EOF
        chmod +x wcp/env.sh
        tar -cJf $GITHUB_WORKSPACE/wine-11.1-staging-tkg-arm64ec.wcp -C wcp .

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: wine-11.1-staging-tkg-arm64ec
        path: wine-11.1-staging-tkg-arm64ec.wcp
