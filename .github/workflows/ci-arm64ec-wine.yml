name: Build Wine ARM64EC + tkg

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  build-arm64ec:
    runs-on: ubuntu-latest

    container:
      image: archlinux:latest

    env:
      LLVM_MINGW_VER: "20260127"
      WCP_NAME: "wine-arm64ec-tkg"

    steps:

    - name: Setup LLVM Mingw URL
      # Формируем переменную LLVM_MINGW_URL через GitHub expression
      run: echo "LLVM_MINGW_URL=https://github.com/mstorsjo/llvm-mingw/releases/download/${{ env.LLVM_MINGW_VER }}/llvm-mingw-${{ env.LLVM_MINGW_VER }}-ucrt-x86_64.tar.xz" >> $GITHUB_ENV

    - name: Sync pacman database
      run: pacman -Sy --noconfirm

    - name: Install dependencies
      run: |
        pacman -Sy --noconfirm \
          base-devel git wget unzip \
          clang lld cmake ninja pkgconf python \
          vulkan-icd-loader freetype2 \
          libx11 libpulse gtk3 libpng giflib \
          openal gnutls libxslt sqlite \
          libjpeg-turbo opencl-icd-loader \
          v4l-utils libxrandr libxcursor \
          libxinerama alsa-lib alsa-plugins \
          gst-plugins-base-libs

    - name: Setup LLVM‑Mingw toolchain
      run: |
        wget $LLVM_MINGW_URL -O llvm-mingw.tar.xz
        tar -xf llvm-mingw.tar.xz -C /opt
        echo "/opt/llvm-mingw-${LLVM_MINGW_VER}-ucrt/bin" >> $GITHUB_PATH

    - name: Checkout Wine arm64ec fork
      run: |
        git clone https://github.com/AndreRH/wine.git wine-src
        cd wine-src
        git checkout arm64ec

    - name: Clone wine‑tkg builder
      run: |
        git clone https://github.com/Frogging-Family/wine-tkg-git.git wine-tkg

    - name: Run build script
      run: |
        chmod +x ./build.sh
        ./build.sh

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.WCP_NAME }}
        path: "*.wcp"