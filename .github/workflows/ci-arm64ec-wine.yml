name: Build Wine 11.1 Staging-TkG ARM64EC + VulkanTURNIP + DXVK + VKD3D

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-arm64ec:
    runs-on: ubuntu-24.04-arm
    defaults:
      run:
        shell: bash

    steps:

    ###################################################
    # 1) Checkout
    ###################################################
    - name: Checkout source
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    ###################################################
    # 2) System deps
    ###################################################
    - name: Install build dependencies
      run: |
        set -euxo pipefail
        sudo apt update
        sudo apt install -y --no-install-recommends \
        build-essential autoconf automake libtool pkg-config python3 python3-pip \
        git gettext flex bison ninja-build cmake \
        libasound2-dev libpulse-dev libv4l-dev libgl-dev \
        libx11-dev libxext-dev libxfixes-dev libxi-dev libxrandr-dev \
        libxrender-dev libxinerama-dev \
        libfontconfig-dev libfreetype-dev libgnutls28-dev \
        libdbus-1-dev libsdl2-dev libvulkan-dev \
        libjpeg-dev libpng-dev libxml2-dev libudev-dev \
        libusb-1.0-0-dev libldap2-dev

        sudo dpkg --add-architecture i386
        sudo apt update
        sudo apt install -y \
        libc6:i386 libdbus-1-dev:i386 libpulse-dev:i386 \
        libv4l-dev:i386 libsdl2-dev:i386 libx11-dev:i386 \
        libxext-dev:i386 libxrandr-dev:i386 \
        libfontconfig-dev:i386 libvulkan-dev:i386

    ###################################################
    # 3) LLVM-mingw (Cross toolchain)
    ###################################################
    - name: Setup llvm-mingw
      run: |
        set -euxo pipefail

        TOOLCHAIN_VER="20260127"
        FILENAME="llvm-mingw-${TOOLCHAIN_VER}-ucrt-ubuntu-22.04-aarch64.tar.xz"
        URL="https://github.com/mstorsjo/llvm-mingw/releases/download/${TOOLCHAIN_VER}/${FILENAME}"

        echo "Checking llvm-mingw archive availability at:"
        echo "$URL"

        # Проверим, доступен ли файл
        if ! wget --spider "$URL"; then
          echo "ERROR: llvm-mingw release tarball not found: $URL" >&2
          exit 1
        fi

        # Скачиваем и распаковываем
        wget -q "$URL"
        mkdir -p llvm-mingw
        tar -xJf "$FILENAME" -C llvm-mingw --strip-components=1

        # Добавим бинарники в PATH
        echo "$PWD/llvm-mingw/bin" >> "$GITHUB_PATH"

    ###################################################
    # 4) Wine + Staging + Tkg
    ###################################################
    - name: Clone Wine & Patches
      run: |
        set -euxo pipefail
        git clone --depth 1 --branch wine-11.1 https://gitlab.winehq.org/wine/wine.git wine
        git clone --depth 1 --branch v11.1 https://github.com/wine-staging/wine-staging.git wine-staging
        git clone https://github.com/Frogging-Family/wine-tkg-git.git wine-tkg

    - name: Apply Staging patches
      run: |
        set -euxo pipefail
        cd wine
        python3 ../wine-staging/staging/patchinstall.py DESTDIR="$(pwd)" --all

    - name: Apply wine-tkg patches
      run: |
        set -euxo pipefail
        cd wine
        for DIR in \
          ../wine-tkg/wine-tkg-git/wine-tkg-patches/esync-fsync \
          ../wine-tkg/wine-tkg-git/wine-tkg-patches/general \
          ../wine-tkg/wine-tkg-git/wine-tkg-patches/misc; do
          for patch in "$DIR"/*.patch; do
            patch -p1 < "$patch" || true
          done
        done

    ###################################################
    # 5) Configure & Compile Wine (with wine‑tools)
    ###################################################
    - name: Configure & Compile Wine
      run: |
        set -euxo pipefail

        cd wine

        # ─── Сборка wine‑tools на build‑машине ───
        mkdir wine-tools-build
        cd wine-tools-build
        ../configure \
          --enable-tools \
          --disable-tests \
          --disable-win16 \
          --enable-archs=aarch64,i386
        make -j"$(nproc)"

        # ─── Возвращаемся для кросс‑сборки Wine ───
        cd ..

        mkdir build
        cd build

        export BUILD=aarch64-linux-gnu
        export HOST=aarch64-w64-mingw32
        export CC=aarch64-w64-mingw32-clang
        export CXX=aarch64-w64-mingw32-clang++
        export AR=aarch64-w64-mingw32-ar
        export LD=aarch64-w64-mingw32-lld
        export RC=aarch64-w64-mingw32-windres
        export RANLIB=aarch64-w64-mingw32-ranlib

        ../configure \
          --build="$BUILD" \
          --host="$HOST" \
          --with-mingw=clang \
          --with-wine-tools="../wine-tools-build" \
          --prefix=/usr \
          --enable-win64 \
          --enable-wow64 \
          --enable-archs=arm64ec,aarch64,i386 \
          --disable-tests \
          --without-mono \
          --without-gecko \
          --with-freetype \
          --with-fontconfig \
          --with-dbus \
          --with-alsa \
          --with-pulse

        make -j"$(nproc)"

    ###################################################
    # 6) Build DXVK
    ###################################################
    - name: Build DXVK
      run: |
        set -euxo pipefail
        git clone https://github.com/doitsujin/dxvk.git dxvk
        cd dxvk
        git submodule update --init --recursive
        pip3 install meson ninja
        meson setup build --cross-file=../wine/build/config/meson.cross.arm64ec.ini \
          --prefix=/usr -Dbuild_tests=false
        ninja -C build && ninja -C build install

    ###################################################
    # 7) Build VKD3D-Proton
    ###################################################
    - name: Build VKD3D-Proton
      run: |
        set -euxo pipefail
        git clone https://github.com/HansKristian-Work/vkd3d-proton.git vkd3d
        cd vkd3d
        git submodule update --init --recursive
        meson setup build --cross-file=../wine/build/config/meson.cross.arm64ec.ini \
          --prefix=/usr -Dbuild_tests=false
        ninja -C build && ninja -C build install

    ###################################################
    # 8) Build Mesa TURNIP Vulkan
    ###################################################
    - name: Build TURNIP Mesa
      run: |
        set -euxo pipefail
        git clone https://gitlab.freedesktop.org/mesa/mesa.git mesa
        cd mesa
        # Apply TURNIP patches if present
        if [ -d "../turnip-ci/patches" ]; then
          for p in ../turnip-ci/patches/*.patch; do
            patch -p1 < "$p" || true
          done
        fi
        pip3 install meson ninja
        meson setup builddir \
          -Dvulkan-drivers=turnip \
          -Dgallium-drivers=freedreno \
          -Dplatforms=android,x11 \
          --cross-file=../wine/build/config/meson.cross.arm64ec.ini \
          -Dbuildtype=release
        ninja -C builddir && ninja -C builddir install

    ###################################################
    # 9) Packaging .wcp
    ###################################################
    - name: Package WCP
      run: |
        set -euxo pipefail
        cd wine/build
        DESTDIR=$PWD/install make install

        cd install
        mkdir -p wcp/{bin,lib/wine,share}
        cp -a usr/bin/* wcp/bin/ 2>/dev/null
        cp -a usr/lib/wine/* wcp/lib/wine/ 2>/dev/null
        cp -a usr/share/* wcp/share/ 2>/dev/null

        cd wcp/bin && ln -sf wine64 wine && cd ../..

        find bin -type f -exec chmod +x {} +
        find lib -name "*.so*" -exec chmod +x {} +

        cat > info.json << 'JSON'
        {
          "name": "Wine-11.1-Staging-TkG",
          "version": "11.1",
          "arch": "arm64ec",
          "variant": "staging-tkg",
          "features": ["staging","vulkan","dxvk","vkd3d"]
        }
        JSON

        cat > env.sh << 'SH'
        #!/bin/sh
        export WINEDEBUG=-all
        export WINEESYNC=1
        export WINEFSYNC=1
        SH
        chmod +x env.sh

        tar -cJf "$GITHUB_WORKSPACE/wine-11.1-staging-tkg-arm64ec.wcp" -C wcp .

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: wine-11.1-staging-tkg-arm64ec
        path: wine-11.1-staging-tkg-arm64ec.wcp
