name: Build Wine 11.1 Staging ARM64EC (PHAT .wcp)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build-arm64ec:
    # Use native GitHub ARM64 runner
    runs-on: ubuntu-24.04-arm

    steps:

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y --no-install-recommends \
            build-essential wget git python3 gettext \
            pkgconf cmake ninja-build autoconf automake libtool \
            libc6-dev libfreetype-dev libfontconfig-dev \
            libsdl2-dev libpulse-dev libasound2-dev \
            libdbus-1-dev libdb-dev \
            libavcodec-dev libavformat-dev libavutil-dev libswscale-dev \
            libudev-dev ca-certificates

          sudo ln -sf /usr/bin/pkgconf /usr/local/bin/pkg-config

      - name: Setup llvm-mingw
        run: |
          mkdir -p "$HOME/llvm-mingw"
          wget -q "https://github.com/mstorsjo/llvm-mingw/releases/download/20251216/llvm-mingw-20251216-ucrt-ubuntu-22.04-x86_64.tar.xz"
          tar -xJf llvm-mingw-20251216-ucrt-ubuntu-22.04-x86_64.tar.xz \
            -C "$HOME/llvm-mingw" --strip-components=1
          rm llvm-mingw-20251216-ucrt-ubuntu-22.04-x86_64.tar.xz
          echo "$HOME/llvm-mingw/bin" >> "$GITHUB_PATH"
          
     
      - name: Clone Wine + Staging
        run: |
          set -e
          git clone --depth 1 -b wine-11.1 https://gitlab.winehq.org/wine/wine.git wine
          git clone --depth 1 -b v11.1 https://gitlab.winehq.org/wine/wine-staging.git staging

      - name: Apply Wine-Staging (exclude fsync/esync)
        run: |
          set +e
          cd staging
          ./staging/patchinstall.py DESTDIR=../wine --all --no-autoconf || true
          cd ../wine

          # Roll back known problematic sync patches
          git apply -R staging/patches/ntdll-fsync/0001*.patch || echo "ntdll-fsync revert ok"
          git apply -R staging/patches/server-Fsync/0001*.patch || echo "server-Fsync revert ok"
          git apply -R staging/patches/ntdll-esync/0001*.patch || echo "ntdll-esync revert ok"
          git apply -R staging/patches/server-Esync/0001*.patch || echo "server-Esync revert ok"
          git apply -R staging/patches/ntdll-Synchronization/0001*.patch || echo "ntdll-Synchronization revert ok"

          echo "Git status after reverting sync patches:"
          git status

          # Regenerate configure scripts
          autoreconf -fiv





      - name: Build Wine with Wow64
        run: |
          mkdir -p build
          cd build
          export PKG_CONFIG=pkg-config
          export PKG_CONFIG_PATH="/usr/lib/aarch64/pkgconfig:${PKG_CONFIG_PATH:-}"
          export CC=aarch64-w64-mingw32-clang
          export CXX=aarch64-w64-mingw32-clang++
          export AR=aarch64-w64-mingw32-ar
          export RANLIB=aarch64-w64-mingw32-ranlib
          export STRIP=aarch64-w64-mingw32-strip

          ../wine/configure \
            --host=aarch64-w64-mingw32 \
            --with-wine-tools=../host \
            --enable-win64 \
            --enable-wow64 \
            --enable-archs=arm64ec,aarch64 \
            --disable-tests \
            --enable-ntsync

          make -j1
          DESTDIR="$PWD/install" make install

      - name: Integrate DXVK, VKD3D, Turnip
        run: |
          mkdir -p build/external
          wget -q https://github.com/Arihany/WinlatorWCPHub/releases/download/DXVK-GPLASYNC-ARM64EC/dxvk-gplasync-arm64ec-2.7.1-1.wcp
          mkdir -p build/external/dxvk
          tar -xJf dxvk-gplasync-arm64ec-2.7.1-1.wcp \
            -C build/external/dxvk
          wget -q https://github.com/Arihany/WinlatorWCPHub/releases/download/VKD3D-PROTON-ARM64EC/vkd3d-proton-arm64ec-3.0b.wcp
          mkdir -p build/external/vkd3d
          tar -xJf vkd3d-proton-arm64ec-3.0b.wcp \
            -C build/external/vkd3d
          wget -q https://github.com/Arihany/WinlatorWCPHub/releases/download/MESA-TURNIP-ARM64EC/mesa-turnip-arm64ec.wcp
          mkdir -p build/external/mesa
          tar -xJf mesa-turnip-arm64ec.wcp \
            -C build/external/mesa

      - name: Unpack FEXCore
        run: |
          mkdir -p wcp/lib/wine/arm64ec-windows
          wget -q https://github.com/Arihany/WinlatorWCPHub/releases/download/FEXCore/FEXCore-2601.wcp -O FEXCore.wcp
          tar -xJf FEXCore.wcp -C wcp/lib/wine/arm64ec-windows

      - name: Prepare PHAT .wcp tree
        run: |
          rm -rf wcp
          mkdir -p wcp/bin wcp/lib/wine/aarch64-unix \
            wcp/lib/wine/aarch64-windows wcp/lib/wine/arm64ec-windows \
            wcp/share/wine wcp/dxvk/arm64ec wcp/vkd3d/arm64ec wcp/mesa/turnip

          cp build/install/bin/{wine,wine64,wineboot,wineserver} wcp/bin/
          cp -rv build/install/lib/* wcp/lib/wine/aarch64-unix/
          cp -rv build/install/lib/* wcp/lib/wine/aarch64-windows/
          cp -rv wcp/lib/wine/arm64ec-windows/* wcp/lib/wine/arm64ec-windows/
          cp -rv build/external/dxvk/* wcp/dxvk/arm64ec/
          cp -rv build/external/vkd3d/* wcp/vkd3d/arm64ec/
          cp -rv build/external/mesa/* wcp/mesa/turnip/

          printf "export WINEPREFIX=~/.wine\nexport WINEARCH=win64\n" > wcp/env.sh
          printf '{ "version":"%s","arch":"arm64ec","type":"phat" }' "$WINE_VERSION" > wcp/info.json

      - name: Upload Wine .wcp
        uses: actions/upload-artifact@v4
        with:
          name: wine-arm64ec-phat
          path: wcp
