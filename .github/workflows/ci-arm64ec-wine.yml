name: Build Wine 11.1 Staging‑TkG ARM64EC + VulkanTURNIP + DXVK + VKD3D

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-arm64ec:
    runs-on: ubuntu-24.04-arm
    defaults:
      run: shell: bash

    steps:
    ############################################################
    # Checkout
    ############################################################
    - name: Checkout source
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    ############################################################
    # Install system dependencies
    ############################################################
    - name: Install build dependencies
      run: |
        set -euxo pipefail
        sudo apt update
        sudo apt install -y --no-install-recommends \
          autoconf automake bash bison build-essential cmake curl \
          git gettext libasound2-dev libdbus-1-dev libfontconfig-dev \
          libfreetype-dev libgl-dev libgnutls28-dev libpciaccess-dev \
          libpulse-dev libudev-dev libusb-1.0-0-dev libv4l-dev \
          libx11-dev libxext-dev libxfixes-dev libxinerama-dev \
          libxi-dev libxrandr-dev libxrender-dev pkgconf python3 \
          python3-pip patchutils perl ninja-build meson flex llvm lld \
          unzip zip wget xz-utils

    ############################################################
    # Install LLVM‑mingw (cross PE toolchain)
    ############################################################
    - name: Setup llvm-mingw
      run: |
        set -euxo pipefail
        TOOLCHAIN_VER="20251216"
        ARCHIVE="llvm-mingw-${TOOLCHAIN_VER}-ucrt-ubuntu-22.04-aarch64.tar.xz"
        URL="https://github.com/mstorsjo/llvm-mingw/releases/download/${TOOLCHAIN_VER}/${ARCHIVE}"
        wget -q "$URL"
        mkdir llvm-mingw
        tar -xJf "$ARCHIVE" -C llvm-mingw --strip-components=1
        rm -f "$ARCHIVE"
        # add to PATH for all subsequent steps
        echo "$PWD/llvm-mingw/bin" >> "$GITHUB_PATH"

    ############################################################
    # Clone Wine sources
    ############################################################
    - name: Clone Wine & staging
      run: |
        set -euxo pipefail
        git clone --depth 1 --branch wine-11.1 https://gitlab.winehq.org/wine/wine.git wine
        git clone --depth 1 --branch v11.1 https://github.com/wine-staging/wine-staging.git wine-staging

    ############################################################
    # Apply Wine‑Staging patches excluding ntdsync
    ############################################################
    - name: Apply staging patches
      run: |
        set -euxo pipefail
        cd wine
        # build exclude patterns for ntdsync patches
        EXCLUDE_ARGS=""
        for P in ../wine-staging/staging/patches/*.patch; do
          case "$(basename "$P")" in
            *ntsync* ) EXCLUDE_ARGS="$EXCLUDE_ARGS -W $(basename "$P")";;
          esac
        done
        python3 ../wine-staging/staging/patchinstall.py --all $EXCLUDE_ARGS --destdir="$(pwd)"
        cd ..

    ############################################################
    # Apply wine‑tkg patchset (esync/fsync + misc)
    ############################################################
    - name: Apply wine-tkg patches
      run: |
        set -euxo pipefail
        cd wine
        git clone https://github.com/Frogging-Family/wine-tkg-git.git wine-tkg-src
        # "esync-fsync", "general", "misc" skipping ntdsync and proton
        for DIR in \
          wine-tkg-src/wine-tkg-git/wine-tkg-patches/esync-fsync \
          wine-tkg-src/wine-tkg-git/wine-tkg-patches/general \
          wine-tkg-src/wine-tkg-git/wine-tkg-patches/misc; do
          for F in $DIR/*.patch; do
            [[ "$F" == *ntsync* ]] && continue
            [[ "$F" == *proton* ]] && continue
            patch -p1 < "$F" || true
          done
        done
        cd ..

    ############################################################
    # Build Wine
    ############################################################
    - name: Prepare build system
      run: |
        set -euxo pipefail
        cd wine
        dlls/winevulkan/make_vulkan
        tools/make_requests
        tools/make_specfiles
        autoreconf -f
        cd ..

    - name: Build wine-tools
      run: |
        set -euxo pipefail
        mkdir wine-tools-build && cd wine-tools-build
        ../wine/configure --enable-tools --disable-tests --disable-win16 --enable-archs=aarch64,i386
        make -j$(nproc) || true
        mkdir -p ../wine-tools
        cp tools/winebuild/winebuild ../wine-tools/ || true
        cp tools/widl/widl ../wine-tools/ || true
        cp tools/wrc/wrc ../wine-tools/ || true
        cp tools/wmc/wmc ../wine-tools/ || true
        cd ..

    - name: Configure & compile Wine
      run: |
        set -euxo pipefail
        mkdir wine-cross
        cd wine-cross
        export BUILD=aarch64-linux-gnu
        export HOST=aarch64-w64-mingw32
        export CC=aarch64-w64-mingw32-clang
        export CXX=aarch64-w64-mingw32-clang++
        export AR=aarch64-w64-mingw32-ar
        export LD=aarch64-w64-mingw32-lld
        export RC=aarch64-w64-mingw32-windres
        export RANLIB=aarch64-w64-mingw32-ranlib

        ../wine/configure \
          --build=$BUILD \
          --host=$HOST \
          --with-mingw=clang \
          --with-wine-tools="../wine-tools" \
          --prefix=/usr \
          --enable-win64 \
          --enable-wow64 \
          --enable-archs=arm64ec,aarch64,i386 \
          --disable-tests \
          --with-freetype \
          --with-fontconfig \
          --with-dbus \
          --with-alsa \
          --with-pulse
        make -j$(nproc)

    ############################################################
    # Build DXVK (Vulkan -> DirectX)
    ############################################################
    - name: Build DXVK
      run: |
        set -euxo pipefail
        git clone https://github.com/doitsujin/dxvk.git
        cd dxvk
        git submodule update --init --recursive
        pip3 install meson ninja
        meson setup build \
          --cross-file=/github/workspace/ci/meson-cross-arm64ec.ini \
          --prefix=/usr \
          -Dbuild_tests=false
        ninja -C build
        ninja -C build install

    ############################################################
    # Build VKD3D‑Proton
    ############################################################
    - name: Build VKD3D-Proton
      run: |
        set -euxo pipefail
        git clone https://github.com/HansKristian-Work/vkd3d-proton.git
        cd vkd3d-proton
        git submodule update --init --recursive
        meson setup build \
          --cross-file=/github/workspace/ci/meson-cross-arm64ec.ini \
          --prefix=/usr \
          -Dbuild_tests=false
        ninja -C build
        ninja -C build install

    ############################################################
    # Build Mesa TURNIP Vulkan
    ############################################################
    - name: Clone Turnip CI patches
      run: |
        set -euxo pipefail
        git clone https://github.com/StevenMXZ/freedreno_turnip-CI.git turnip-ci || true

    - name: Prepare Mesa (Turnip+Patched)
      run: |
        set -euxo pipefail
        git clone https://gitlab.freedesktop.org/mesa/mesa.git
        cd mesa
        if [[ -d ../turnip-ci/patches ]]; then
          for P in ../turnip-ci/patches/*.patch; do
            patch -p1 < "$P" || true
          done
        fi
        cd ..

    - name: Build Mesa TURNIP Vulkan
      run: |
        set -euxo pipefail
        cd mesa
        pip3 install meson ninja
        meson setup builddir \
          -Dvulkan-drivers=turnip \
          -Dgallium-drivers=freedreno \
          -Dplatforms=android,x11 \
          --cross-file=/github/workspace/ci/meson-cross-arm64ec.ini \
          -Dbuildtype=release
        ninja -C builddir
        ninja -C builddir install

    ############################################################
    # Package results
    ############################################################
    - name: Package WCP
      run: |
        # … твои существующие packaging шаги сюда …
        echo "Packaging placeholder"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: wine-arm64ec-full
        path: "*.wcp"
