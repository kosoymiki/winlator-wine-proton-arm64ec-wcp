name: Build Wine 11.1 Staging ARM64EC (PHAT .wcp)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build-arm64ec:
    runs-on: ubuntu-24.04-arm

    env:
      WORKDIR: $GITHUB_WORKSPACE
      WINEDIR: $WORKDIR/src/wine
      STAGINGDIR: $WORKDIR/src/wine-staging
      BUILDDIR: $WORKDIR/build/wine
      EXTERNALDIR: $WORKDIR/build/external
      WCP_DIR: $WORKDIR/wcp
      LLVM_MINGW_VERSION: "20251216"
      LLVM_MINGW_DIR: $HOME/llvm-mingw
      WINE_VERSION: "11.1"

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ensure full history for tag + commit checkout

    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y --no-install-recommends \
          build-essential wget git python3 gettext \
          pkgconf cmake ninja-build meson autoconf automake libtool \
          libc6-dev libfreetype-dev libfontconfig-dev \
          libsdl2-dev libpulse-dev libasound2-dev \
          libdbus-1-dev libdb-dev \
          libavcodec-dev libavformat-dev libavutil-dev libswscale-dev \
          libudev-dev ca-certificates patchutils bison flex
        sudo ln -sf /usr/bin/pkgconf /usr/local/bin/pkg-config

    - name: Setup LLVM‑Mingw ARM64EC
      run: |
        mkdir -p "$LLVM_MINGW_DIR"
        wget -q \
"https://github.com/mstorsjo/llvm-mingw/releases/download/${LLVM_MINGW_VERSION}/llvm-mingw-${LLVM_MINGW_VERSION}-ucrt-ubuntu-22.04-aarch64.tar.xz" \
          -O llvm-mingw.tar.xz
        tar -xJf llvm-mingw.tar.xz -C "$LLVM_MINGW_DIR" --strip-components=1
        rm llvm-mingw.tar.xz
        echo "$LLVM_MINGW_DIR/bin" >> "$GITHUB_PATH"

    - name: Verify cross‑compiler
      run: |
        set -eux
        which aarch64-w64-mingw32-clang
        aarch64-w64-mingw32-clang --version
        echo 'int main(){return 0;}' > /tmp/t.c
        aarch64-w64-mingw32-clang --target=aarch64-w64-mingw32 \
          -o /tmp/t.exe /tmp/t.c -Wl,--no-undefined
        file /tmp/t.exe

    - name: Clone Wine & Wine‑Staging with tags
      run: |
        mkdir -p "$WORKDIR/src"
        cd "$WORKDIR/src"

        git clone https://gitlab.winehq.org/wine/wine.git wine
        cd wine
        git fetch --tags
        git checkout "v$WINE_VERSION"

        cd "$WORKDIR/src"
        git clone https://gitlab.winehq.org/wine/wine-staging.git wine-staging
        cd wine-staging
        git fetch --tags
        git checkout "v$WINE_VERSION"

    - name: Determine staging upstream commit
      id: upstream
      run: |
        cd "$STAGINGDIR/staging"
        UPSTREAM=$(./patchinstall.py --upstream-commit)
        echo "upstream_commit=$UPSTREAM" >> "$GITHUB_OUTPUT"

    - name: Checkout Wine‑src at staging upstream commit
      run: |
        cd "$WINEDIR"
        git fetch origin
        git checkout ${{ steps.upstream.outputs.upstream_commit }}

    - name: Apply staging patches
      run: |
        set -eux
        cd "$STAGINGDIR/staging"
        python3 patchinstall.py DESTDIR="$WINEDIR" --all --no-autoconf
        cd "$WINEDIR"
        autoreconf -fiv

    - name: Verify configure script
      run: |
        cd "$WINEDIR"
        test -f configure
        ./configure --help | head -n 20

    - name: Build Wine
      run: |
        mkdir -p "$BUILDDIR"
        cd "$BUILDDIR"
        export CC=aarch64-w64-mingw32-clang
        export CXX=aarch64-w64-mingw32-clang++
        export PKG_CONFIG=pkg-config
        export PKG_CONFIG_PATH=""

        "$WINEDIR/configure" \
          --host=aarch64-w64-mingw32 \
          --enable-win64 \
          --enable-wow64 \
          --enable-archs=arm64ec,aarch64 \
          --disable-tests \
          --without-vulkan

        make -j$(nproc)
        DESTDIR="$BUILDDIR/install" make install

    - name: Build Mesa Turnip Vulkan driver
      run: |
        git clone https://github.com/whitebelyash/mesa-tu8 meson-mesa
        mkdir meson-mesa-build
        cd meson-mesa-build
        meson setup . ../meson-mesa \
          -Dvulkan-drivers=turnip \
          -Dplatforms=none \
          -Dbuildtype=release
        ninja
        ninja install --destdir="$EXTERNALDIR/mesa"

    - name: Integrate DXVK/VKD3D
      run: |
        mkdir -p "$EXTERNALDIR/dxvk" "$EXTERNALDIR/vkd3d"
        wget -q "https://github.com/Arihany/WinlatorWCPHub/releases/download/DXVK-GPLASYNC-ARM64EC/dxvk-gplasync-arm64ec-2.7.1-1.wcp"
        tar -xJf dxvk-gplasync-arm64ec-2.7.1-1.wcp -C "$EXTERNALDIR/dxvk"
        wget -q "https://github.com/Arihany/WinlatorWCPHub/releases/download/VKD3D-PROTON-ARM64EC/vkd3d-proton-arm64ec-3.0b.wcp"
        tar -xJf vkd3d-proton-arm64ec-3.0b.wcp -C "$EXTERNALDIR/vkd3d"

    - name: Unpack FEXCore
      run: |
        mkdir -p "$WCP_DIR/lib/wine/arm64ec-windows"
        wget -q "https://github.com/Arihany/WinlatorWCPHub/releases/download/FEXCore/FEXCore-2601.wcp" -O FEXCore.wcp
        tar -xJf FEXCore.wcp -C "$WCP_DIR/lib/wine/arm64ec-windows"

    - name: Prepare PHAT .wcp
      run: |
        rm -rf "$WCP_DIR"
        mkdir -p "$WCP_DIR"/{bin,share/wine,dxvk/arm64ec,vkd3d/arm64ec,mesa/turnip}
        mkdir -p "$WCP_DIR/lib/wine"/{aarch64-unix,aarch64-windows,arm64ec-windows}

        cp "$BUILDDIR/install/bin/"{wine,wine64,wineboot,wineserver} "$WCP_DIR/bin/"
        cp -rv "$BUILDDIR/install/lib/"*.so   "$WCP_DIR/lib/wine/aarch64-unix/"      2>/dev/null || true
        cp -rv "$BUILDDIR/install/lib/"*.dll.so "$WCP_DIR/lib/wine/aarch64-windows/" 2>/dev/null || true
        cp -rv "$WCP_DIR/lib/wine/arm64ec-windows/"* "$WCP_DIR/lib/wine/arm64ec-windows/" 2>/dev/null || true
        cp -rv "$EXTERNALDIR/dxvk/"*   "$WCP_DIR/dxvk/arm64ec/"
        cp -rv "$EXTERNALDIR/vkd3d/"*  "$WCP_DIR/vkd3d/arm64ec/"
        cp -rv "$EXTERNALDIR/mesa/"*   "$WCP_DIR/mesa/turnip/"

        cat > "$WCP_DIR/env.sh" << 'EOF'
        export WINEPREFIX=~/.wine
        export WINEARCH=win64
        EOF
        chmod +x "$WCP_DIR/env.sh"

        cat > "$WCP_DIR/info.json" <<EOF
        {
          "name": "Wine-11.1-Staging-ARM64EC",
          "version": "$WINE_VERSION",
          "arch": "arm64ec",
          "type": "phat"
        }
        EOF

    - name: Upload .wcp artifact
      uses: actions/upload-artifact@v4
      with:
        name: wine-arm64ec-phat
        path: ${{ env.WCP_DIR }}
