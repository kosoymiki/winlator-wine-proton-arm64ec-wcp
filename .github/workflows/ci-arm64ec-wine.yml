name: Build Wine 11.1 Staging‑TkG ARM64EC + DXVK/VKD3D + Mesa TURNIP

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-arm64ec:
    runs-on: ubuntu-24.04-arm
    defaults:
      run:
        shell: bash

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install dependencies
      run: |
        set -euxo pipefail
        sudo apt update
        sudo apt install -y --no-install-recommends \
          build-essential git wget curl python3 python3-pip perl gettext \
          pkgconf cmake ninja-build meson autoconf automake libtool \
          patchutils bison flex libc6-dev linux-libc-dev \
          libfreetype-dev libfontconfig-dev libdbus-1-dev \
          libx11-dev libxext-dev libxrender-dev libxrandr-dev \
          libxinerama-dev libxcursor-dev libxi-dev libxfixes-dev \
          libsdl2-dev libpulse-dev libasound2-dev libudev-dev \
          libgl-dev libusb-1.0-0-dev libv4l-dev libpcap-dev \
          libpcsclite-dev libkrb5-dev libcups2-dev libgnutls28-dev \
          libsane-dev rsync file zip xz-utils unzip llvm lld mingw-w64 \
          libvulkan-dev

    - name: Setup llvm-mingw
      run: |
        set -euxo pipefail
        VERSION="20251216"
        ASSET="llvm-mingw-${VERSION}-ucrt-ubuntu-22.04-aarch64.tar.xz"
        wget -q "https://github.com/mstorsjo/llvm-mingw/releases/download/${VERSION}/${ASSET}"
        mkdir llvm-mingw
        tar -xJf "${ASSET}" -C llvm-mingw --strip-components=1
        echo "$PWD/llvm-mingw/bin" >> "$GITHUB_PATH"

    - name: Clone Wine & staging
      run: |
        set -euxo pipefail
        git clone --depth 1 --branch wine-11.1 https://gitlab.winehq.org/wine/wine.git wine
        git clone --depth 1 --branch v11.1 https://github.com/wine-staging/wine-staging.git wine-staging

    - name: Apply wine-staging patches (exclude ntdsync)
      run: |
        set -euxo pipefail
        cd wine
        EXCLUDES=""
        for P in ../wine-staging/staging/patches/*.patch; do
          case "$(basename "$P")" in
            *ntsync*|*Syscall* ) EXCLUDES="$EXCLUDES -W $(basename $P)";;
          esac
        done
        python3 ../wine-staging/staging/patchinstall.py --all $EXCLUDES --destdir="$(pwd)"
        cd ..

    - name: Apply tkg patches (esync/fsync etc.)
      run: |
        set -euxo pipefail
        cd wine
        git clone https://github.com/Frogging-Family/wine-tkg-git.git wine-tkg
        cd wine-tkg/wine-tkg-git
        for D in wine-tkg-patches/esync-fsync wine-tkg-patches/general wine-tkg-patches/misc; do
          for F in $D/*.patch; do
            [[ "$F" == *ntsync* ]] && continue
            patch -p1 < "$F" || true
          done
        done
        cd ../../..
    
    # =========================
    # Build Wine
    # =========================

    - name: Prepare Wine build
      run: |
        set -euxo pipefail
        cd wine
        dlls/winevulkan/make_vulkan
        tools/make_requests
        tools/make_specfiles
        autoreconf -f
        cd ..

    - name: Build wine tools
      run: |
        set -euxo pipefail
        mkdir wine-tools-build && cd wine-tools-build
        ../wine/configure --enable-tools --disable-tests --disable-win16 --enable-archs=aarch64,i386
        make -j$(nproc) || true
        mkdir -p ../wine-tools
        cp tools/winebuild/winebuild ../wine-tools/ || true
        cp tools/widl/widl ../wine-tools/ || true
        cp tools/wrc/wrc ../wine-tools/ || true
        cp tools/wmc/wmc ../wine-tools/ || true
        cd ..

    - name: Configure and build Wine
      run: |
        set -euxo pipefail
        export PATH="$PWD/llvm-mingw/bin:$PATH"
        mkdir wine-cross && cd wine-cross
        export BUILD=aarch64-linux-gnu
        export HOST=aarch64-w64-mingw32
        export CC=aarch64-w64-mingw32-clang
        export CXX=aarch64-w64-mingw32-clang++
        export AR=aarch64-w64-mingw32-ar
        export LD=aarch64-w64-mingw32-lld
        export RC=aarch64-w64-mingw32-windres
        export RANLIB=aarch64-w64-mingw32-ranlib

        ../wine/configure \
          --build=$BUILD --host=$HOST \
          --with-mingw=clang \
          --with-wine-tools="../wine-tools" \
          --prefix=/usr \
          --enable-win64 --enable-wow64 \
          --enable-archs=arm64ec,aarch64,i386 \
          --disable-tests \
          --with-freetype --with-fontconfig \
          --with-dbus \
          --with-alsa --with-pulse

        make -j$(nproc)

    # =========================
    # Build DXVK
    # =========================

    - name: Build DXVK
      run: |
        set -euxo pipefail
        git clone https://github.com/doitsujin/dxvk.git
        cd dxvk
        git submodule update --init --recursive
        meson setup build \
          --cross-file=/github/workspace/ci/meson-cross-arm64ec.ini \
          --prefix=/usr \
          -Dbuild_tests=false -Dvulkan_headers_dependency=system
        ninja -C build
        ninja -C build install

    # =========================
    # Build VKD3D‑Proton
    # =========================

    - name: Build VKD3D‑Proton
      run: |
        set -euxo pipefail
        git clone https://github.com/HansKristian-Work/vkd3d-proton.git
        cd vkd3d-proton
        git submodule update --init --recursive
        meson setup build \
          --cross-file=/github/workspace/ci/meson-cross-arm64ec.ini \
          --prefix=/usr \
          -Dbuild_tests=false
        ninja -C build
        ninja -C build install

    # =========================
    # Build Mesa TURNIP (Vulkan driver)
    # =========================

    - name: Clone Turnip‑CI patches
      run: |
        set -euxo pipefail
        git clone https://github.com/StevenMXZ/freedreno_turnip-CI.git turnip-ci

    - name: Clone and patch Mesa for TURNIP Vulkan
      run: |
        set -euxo pipefail
        git clone https://gitlab.freedesktop.org/mesa/mesa.git
        cd mesa
        if [[ -d ../turnip-ci/patches ]]; then
          for P in ../turnip-ci/patches/*.patch; do
            patch -p1 < "$P" || true
          done
        fi
        cd ..

    - name: Build Mesa TURNIP Vulkan
      run: |
        set -euxo pipefail
        cd mesa
        meson setup builddir \
          -Dvulkan-drivers=turnip \
          -Dgallium-drivers=freedreno \
          -Dplatforms=android,x11 \
          --cross-file=/github/workspace/ci/meson-cross-arm64ec.ini \
          -Dbuildtype=release
        ninja -C builddir
        ninja -C builddir install

    # =========================
    # Packaging (your existing steps)
    # =========================

    - name: Package and upload
      run: |
        # … ваши шаги упаковки (WCP, профили, env.sh и т.д.)

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: wine‑mesa‑turnip‑arm64ec
        path: *.wcp
