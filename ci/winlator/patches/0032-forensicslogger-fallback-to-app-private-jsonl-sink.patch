From 08da2707f08bf5660b6e41aad69385e7c6edd087 Mon Sep 17 00:00:00 2001
From: Codex <codex@local>
Date: Tue, 24 Feb 2026 22:06:56 +0300
Subject: [PATCH] forensics: fallback jsonl sink to app-private storage

---
 .../winlator/cmod/core/ForensicLogger.java    | 125 +++++++++++++++---
 1 file changed, 108 insertions(+), 17 deletions(-)

diff --git a/app/src/main/java/com/winlator/cmod/core/ForensicLogger.java b/app/src/main/java/com/winlator/cmod/core/ForensicLogger.java
index d09fad4..843c7be 100644
--- a/app/src/main/java/com/winlator/cmod/core/ForensicLogger.java
+++ b/app/src/main/java/com/winlator/cmod/core/ForensicLogger.java
@@ -26,9 +26,12 @@ import java.util.Locale;
 public final class ForensicLogger {
     private static final String TAG = "ForensicLogger";
     private static final Object FILE_LOCK = new Object();
+    private static final String SINK_EXTERNAL = "external";
+    private static final String SINK_APP_PRIVATE = "app_private";
     private static final ThreadLocal<SimpleDateFormat> TS_FORMAT = ThreadLocal.withInitial(
             () -> new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss.SSSZ", Locale.US)
     );
+    private static String currentFileSinkId = "";
 
     private ForensicLogger() {}
 
@@ -102,14 +105,7 @@ public final class ForensicLogger {
         if (context == null) return;
 
         synchronized (FILE_LOCK) {
-            File out = getCurrentLogFile(context);
-            try (BufferedWriter writer = new BufferedWriter(new FileWriter(out, true))) {
-                writer.write(line);
-                writer.newLine();
-            }
-            catch (IOException e) {
-                Log.e(TAG, "Failed writing forensic jsonl", e);
-            }
+            appendForensicLine(context, line);
         }
     }
 
@@ -152,7 +148,13 @@ public final class ForensicLogger {
     }
 
     public static File getForensicsDir(Context context) {
-        File dir = new File(WinlatorLogUtils.getLogsDir(context), "forensics");
+        File dir = getExternalForensicsDir(context);
+        if (!dir.exists()) dir.mkdirs();
+        return dir;
+    }
+
+    public static File getAppPrivateForensicsDir(Context context) {
+        File dir = new File(new File(context.getFilesDir(), "Winlator/logs"), "forensics");
         if (!dir.exists()) dir.mkdirs();
         return dir;
     }
@@ -163,14 +165,11 @@ public final class ForensicLogger {
     }
 
     public static File getLatestLogFile(Context context) {
-        File dir = getForensicsDir(context);
-        File[] files = dir.listFiles((d, name) -> name.endsWith(".jsonl"));
-        if (files == null || files.length == 0) return null;
-        File latest = files[0];
-        for (File file : files) {
-            if (file.lastModified() > latest.lastModified()) latest = file;
-        }
-        return latest;
+        File latest = getLatestJsonlInDir(getExternalForensicsDir(context));
+        File appPrivateLatest = getLatestJsonlInDir(getAppPrivateForensicsDir(context));
+        if (latest == null) return appPrivateLatest;
+        if (appPrivateLatest == null) return latest;
+        return appPrivateLatest.lastModified() > latest.lastModified() ? appPrivateLatest : latest;
     }
 
     public static String describeLatestTrace(Context context) {
@@ -239,4 +238,96 @@ public final class ForensicLogger {
     private static String sanitize(String value) {
         return value == null ? "" : value;
     }
+
+    private static File getExternalForensicsDir(Context context) {
+        return new File(WinlatorLogUtils.getLogsDir(context), "forensics");
+    }
+
+    private static File getCurrentLogFile(File dir) {
+        String fileName = "forensics_" + DateFormat.format("yyyy-MM-dd", new Date()) + ".jsonl";
+        return new File(dir, fileName);
+    }
+
+    private static File getLatestJsonlInDir(File dir) {
+        File[] files = dir.listFiles((d, name) -> name.endsWith(".jsonl"));
+        if (files == null || files.length == 0) return null;
+        File latest = files[0];
+        for (File file : files) {
+            if (file.lastModified() > latest.lastModified()) latest = file;
+        }
+        return latest;
+    }
+
+    private static void appendForensicLine(Context context, String line) {
+        IOException externalError = null;
+        File externalDir = getExternalForensicsDir(context);
+        try {
+            appendLineWithSink(context, getCurrentLogFile(externalDir), line, SINK_EXTERNAL, null);
+            return;
+        }
+        catch (IOException e) {
+            externalError = e;
+            Log.w(TAG, "External forensic sink unavailable, trying app-private fallback", e);
+        }
+
+        try {
+            appendLineWithSink(context, getCurrentLogFile(getAppPrivateForensicsDir(context)), line, SINK_APP_PRIVATE, externalError);
+        }
+        catch (IOException e) {
+            Log.e(TAG, "Failed writing forensic jsonl to all sinks", e);
+        }
+    }
+
+    private static void appendLineWithSink(Context context, File out, String line, String sinkId, IOException switchReason) throws IOException {
+        File dir = out.getParentFile();
+        if (dir == null || (!dir.exists() && !dir.mkdirs() && !dir.exists())) {
+            throw new IOException("Unable to create forensic dir: " + (dir == null ? "<null>" : dir.getAbsolutePath()));
+        }
+
+        String sinkSwitchLine = null;
+        if (!sinkId.equals(currentFileSinkId)) {
+            sinkSwitchLine = buildSinkSwitchLine(context, out, sinkId, switchReason);
+            currentFileSinkId = sinkId;
+        }
+
+        try (BufferedWriter writer = new BufferedWriter(new FileWriter(out, true))) {
+            if (sinkSwitchLine != null) {
+                writer.write(sinkSwitchLine);
+                writer.newLine();
+            }
+            writer.write(line);
+            writer.newLine();
+        }
+    }
+
+    private static String buildSinkSwitchLine(Context context, File out, String sinkId, IOException switchReason) {
+        JSONObject obj = new JSONObject();
+        try {
+            obj.put("ts", TS_FORMAT.get().format(new Date()));
+            obj.put("event_id", "FORENSIC_SINK_SWITCH");
+            obj.put("severity", SINK_APP_PRIVATE.equals(sinkId) ? "warn" : "info");
+            obj.put("trace_id", JSONObject.NULL);
+            obj.put("stage", "forensics_file_sink");
+            obj.put("message", SINK_APP_PRIVATE.equals(sinkId)
+                    ? "Switched forensic file sink to app-private storage"
+                    : "Switched forensic file sink to external storage");
+            obj.put("sink_id", sinkId);
+            obj.put("sink_path", out.getAbsolutePath());
+            obj.put("package_name", context != null ? context.getPackageName() : "");
+            if (switchReason != null) {
+                obj.put("fallback_reason", String.valueOf(switchReason.getMessage()));
+                obj.put("fallback_error_class", switchReason.getClass().getName());
+            }
+        }
+        catch (JSONException e) {
+            return null;
+        }
+
+        if (SINK_APP_PRIVATE.equals(sinkId)) {
+            Log.w(TAG, "Forensic file sink switched to app-private: " + out.getAbsolutePath());
+        } else {
+            Log.i(TAG, "Forensic file sink switched to external: " + out.getAbsolutePath());
+        }
+        return obj.toString();
+    }
 }
-- 
2.43.0

