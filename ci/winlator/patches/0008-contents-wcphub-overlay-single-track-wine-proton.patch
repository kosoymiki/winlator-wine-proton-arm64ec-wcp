From 82c5ae22a7563956d2fa1d65eea3b95cac5bc67b Mon Sep 17 00:00:00 2001
From: Codex <codex@local>
Date: Tue, 24 Feb 2026 04:05:32 +0300
Subject: [PATCH] winlator: use WCP Hub plus Wine/Proton overlay and simplify
 package channels

---
 .../com/winlator/cmod/ContentsFragment.java   | 36 ++++++++++++-------
 .../cmod/contentdialog/ContentInfoDialog.java | 32 +++++++++++------
 .../cmod/contents/ContentProfile.java         |  4 +++
 .../cmod/contents/ContentsManager.java        | 24 +++++++++++--
 app/src/main/res/values/strings.xml           |  4 +--
 5 files changed, 72 insertions(+), 28 deletions(-)

diff --git a/app/src/main/java/com/winlator/cmod/ContentsFragment.java b/app/src/main/java/com/winlator/cmod/ContentsFragment.java
index 37beb41..deb93cd 100644
--- a/app/src/main/java/com/winlator/cmod/ContentsFragment.java
+++ b/app/src/main/java/com/winlator/cmod/ContentsFragment.java
@@ -48,8 +48,9 @@ import java.util.List;
 import java.util.Locale;
 import java.util.concurrent.Executors;
 
-public class ContentsFragment extends Fragment {
-    private RecyclerView recyclerView;
+public class ContentsFragment extends Fragment {
+    private static final String DASH_PLACEHOLDER = "\u2014";
+    private RecyclerView recyclerView;
     private View emptyText;
     private ContentsManager manager;
     SharedPreferences sp;
@@ -169,12 +170,13 @@ public class ContentsFragment extends Fragment {
 
     private void reloadRemoteContents() {
         new Thread(() -> {
-            String contentsURL = sp.getString("downloadable_contents_url", ContentsManager.REMOTE_PROFILES);
-            String json = Downloader.downloadString(contentsURL);
-            if (json == null || !isAdded() || getActivity() == null)
+            String hubContentsUrl = sp.getString("downloadable_contents_url", ContentsManager.REMOTE_PROFILES);
+            String hubJson = Downloader.downloadString(hubContentsUrl);
+            String wineProtonOverlayJson = Downloader.downloadString(ContentsManager.REMOTE_WINE_PROTON_OVERLAY);
+            if ((hubJson == null && wineProtonOverlayJson == null) || !isAdded() || getActivity() == null)
                 return;
             getActivity().runOnUiThread(() -> {
-                manager.setRemoteProfiles(json, showBeta, false);
+                manager.setCompositeRemoteProfiles(hubJson, wineProtonOverlayJson, showBeta);
                 loadContentList();
             });
         }).start();
@@ -206,13 +208,19 @@ public class ContentsFragment extends Fragment {
     }
 
     private String buildProfileTitleLine(ContentProfile profile) {
-        return getDisplayCategory(profile) + " • " + profile.verName;
+        String category = dashIfBlank(getDisplayCategory(profile));
+        String version = dashIfBlank(profile.verName);
+        return category + " • " + version;
     }
 
     private String buildProfileMetaLine(ContentProfile profile) {
-        return getString(R.string.version_code) + ": " + profile.verCode
-                + " • " + getChannelLabel(profile)
-                + " • " + getDeliveryLabel(profile);
+        StringBuilder line = new StringBuilder();
+        line.append(getString(R.string.version_code)).append(": ").append(profile.verCode);
+        if (!profile.isWineProtonFamily()) {
+            line.append(" • ").append(getChannelLabel(profile));
+        }
+        line.append(" • ").append(getDeliveryLabel(profile));
+        return line.toString();
     }
 
     private String buildProfileSourceLine(ContentProfile profile) {
@@ -225,7 +233,11 @@ public class ContentsFragment extends Fragment {
             return line;
         }
         if (profile.isRemoteDownloadable()) return getString(R.string.package_source_online_not_embedded);
-        return "";
+        return DASH_PLACEHOLDER;
+    }
+
+    private String dashIfBlank(String value) {
+        return (value == null || value.trim().isEmpty()) ? DASH_PLACEHOLDER : value.trim();
     }
 
     private void updateContentsListView() {
@@ -374,7 +386,7 @@ public class ContentsFragment extends Fragment {
             holder.tvVersionCode.setText(buildProfileMetaLine(profile));
             String sourceLine = buildProfileSourceLine(profile);
             holder.tvSource.setText(sourceLine);
-            holder.tvSource.setVisibility(sourceLine.isEmpty() ? View.GONE : View.VISIBLE);
+            holder.tvSource.setVisibility(View.VISIBLE);
             holder.ibMenu.setVisibility(profile.isRemoteDownloadable() ? View.GONE : View.VISIBLE);
             holder.ibMenu.setOnClickListener(v -> {
                 PopupMenu selectionMenu = new PopupMenu(getContext(), holder.ibMenu);
diff --git a/app/src/main/java/com/winlator/cmod/contentdialog/ContentInfoDialog.java b/app/src/main/java/com/winlator/cmod/contentdialog/ContentInfoDialog.java
index 349c112..003e937 100644
--- a/app/src/main/java/com/winlator/cmod/contentdialog/ContentInfoDialog.java
+++ b/app/src/main/java/com/winlator/cmod/contentdialog/ContentInfoDialog.java
@@ -17,8 +17,10 @@ import com.winlator.cmod.contents.ContentProfile;
 import java.util.Collections;
 import java.util.List;
 
-public class ContentInfoDialog extends ContentDialog {
-    public ContentInfoDialog(Context context, ContentProfile profile) {
+public class ContentInfoDialog extends ContentDialog {
+    private static final String DASH_PLACEHOLDER = "\u2014";
+
+    public ContentInfoDialog(Context context, ContentProfile profile) {
         super(context, R.layout.content_info_dialog);
         setIcon(R.drawable.icon_about);
         setTitle(R.string.content_info);
@@ -29,12 +31,12 @@ public class ContentInfoDialog extends ContentDialog {
         TextView tvDescription = findViewById(R.id.TVDesc);
         RecyclerView recyclerView = findViewById(R.id.recyclerView);
 
-        tvType.setText(profile.getDisplayCategory());
-        tvVersion.setText(profile.verName);
+        tvType.setText(orDash(profile.getDisplayCategory()));
+        tvVersion.setText(orDash(profile.verName));
         tvVersionCode.setText(String.valueOf(profile.verCode));
         StringBuilder descBuilder = new StringBuilder();
         if (profile.desc != null && !profile.desc.isEmpty()) descBuilder.append(profile.desc);
-        if (profile.channel != null && !profile.channel.isEmpty()) {
+        if (!profile.isWineProtonFamily() && profile.channel != null && !profile.channel.isEmpty()) {
             if (descBuilder.length() > 0) descBuilder.append("\n\n");
             descBuilder.append("Channel: ").append(profile.getChannel());
         }
@@ -47,12 +49,16 @@ public class ContentInfoDialog extends ContentDialog {
         if (profile.releaseTag != null && !profile.releaseTag.isEmpty()) {
             descBuilder.append("\nRelease tag: ").append(profile.releaseTag);
         }
-        tvDescription.setText(descBuilder.toString());
+        if (profile.sourceVersion != null && !profile.sourceVersion.isEmpty()) {
+            descBuilder.append("\nSource version: ").append(profile.sourceVersion);
+        }
+        if (profile.artifactName != null && !profile.artifactName.isEmpty()) {
+            descBuilder.append("\nArtifact: ").append(profile.artifactName);
+        }
+        if (profile.sha256Url != null && !profile.sha256Url.isEmpty()) {
+            descBuilder.append("\nSHA256: ").append(profile.sha256Url);
+        }
+        tvDescription.setText(descBuilder.length() == 0 ? DASH_PLACEHOLDER : descBuilder.toString());
         recyclerView.setAdapter(new ContentInfoFileAdapter(profile.fileList == null ? Collections.emptyList() : profile.fileList));
         recyclerView.setLayoutManager(new LinearLayoutManager(recyclerView.getContext()));
         recyclerView.addItemDecoration(new DividerItemDecoration(recyclerView.getContext(), DividerItemDecoration.VERTICAL));
 
-    }
+    }
+
+    private static String orDash(String value) {
+        return (value == null || value.trim().isEmpty()) ? DASH_PLACEHOLDER : value.trim();
+    }
 
     public static class ContentInfoFileAdapter extends RecyclerView.Adapter<ContentInfoFileAdapter.ViewHolder> {
         private static class ViewHolder extends RecyclerView.ViewHolder {
@@ -79,10 +85,14 @@ public class ContentInfoDialog extends ContentDialog {
         }
 
         @Override
-        public void onBindViewHolder(@NonNull ViewHolder holder, int position) {
-            holder.tvSource.setText(data.get(position).source + " ->");
-            holder.tvtarget.setText('\t' + data.get(position).target);
-        }
+        public void onBindViewHolder(@NonNull ViewHolder holder, int position) {
+            String source = data.get(position).source == null || data.get(position).source.trim().isEmpty()
+                    ? DASH_PLACEHOLDER : data.get(position).source;
+            String target = data.get(position).target == null || data.get(position).target.trim().isEmpty()
+                    ? DASH_PLACEHOLDER : data.get(position).target;
+            holder.tvSource.setText(source + " ->");
+            holder.tvtarget.setText('\t' + target);
+        }
 
         @Override
         public int getItemCount() {
diff --git a/app/src/main/java/com/winlator/cmod/contents/ContentProfile.java b/app/src/main/java/com/winlator/cmod/contents/ContentProfile.java
index b55681e..b881714 100644
--- a/app/src/main/java/com/winlator/cmod/contents/ContentProfile.java
+++ b/app/src/main/java/com/winlator/cmod/contents/ContentProfile.java
@@ -95,6 +95,10 @@ public class ContentProfile {
         return CHANNEL_BETA.equals(ch) || CHANNEL_NIGHTLY.equals(ch);
     }
 
+    public boolean isWineProtonFamily() {
+        return type == ContentType.CONTENT_TYPE_WINE;
+    }
+
     public boolean isRemoteDownloadable() {
         return remoteUrl != null && !remoteUrl.trim().isEmpty();
     }
diff --git a/app/src/main/java/com/winlator/cmod/contents/ContentsManager.java b/app/src/main/java/com/winlator/cmod/contents/ContentsManager.java
index 3e5d93b..e59d8a6 100644
--- a/app/src/main/java/com/winlator/cmod/contents/ContentsManager.java
+++ b/app/src/main/java/com/winlator/cmod/contents/ContentsManager.java
@@ -24,7 +24,8 @@ import java.util.Map;
 
 public class ContentsManager {
     public static final String PROFILE_NAME = "profile.json";
-    public static final String REMOTE_PROFILES = "https://raw.githubusercontent.com/kosoymiki/winlator-wine-proton-arm64ec-wcp/main/contents/contents.json";
+    public static final String REMOTE_PROFILES = "https://raw.githubusercontent.com/StevenMXZ/Winlator-Contents/main/contents.json";
+    public static final String REMOTE_WINE_PROTON_OVERLAY = "https://raw.githubusercontent.com/kosoymiki/winlator-wine-proton-arm64ec-wcp/main/contents/contents.json";
     public static final String[] DXVK_TRUST_FILES = {"${system32}/d3d8.dll", "${system32}/d3d9.dll", "${system32}/d3d10.dll", "${system32}/d3d10_1.dll",
             "${system32}/d3d10core.dll", "${system32}/d3d11.dll", "${system32}/dxgi.dll", "${syswow64}/d3d8.dll", "${syswow64}/d3d9.dll", "${syswow64}/d3d10.dll",
             "${syswow64}/d3d10_1.dll", "${syswow64}/d3d10core.dll", "${syswow64}/d3d11.dll", "${syswow64}/dxgi.dll"};
@@ -96,8 +97,23 @@ public class ContentsManager {
     }
 
     public void setRemoteProfiles(String json, boolean includeBeta, boolean ignoreWine) {
+        remoteProfiles = new ArrayList<>();
+        appendRemoteProfiles(json, includeBeta, ignoreWine, false);
+        syncContents();
+    }
+
+    public void setCompositeRemoteProfiles(String hubJson, String wineProtonOverlayJson, boolean includeBeta) {
+        remoteProfiles = new ArrayList<>();
+        // WCP Hub: keep channel filtering, exclude Wine/Proton family to avoid duplicates with our overlay.
+        appendRemoteProfiles(hubJson, includeBeta, true, false);
+        // Our overlay: Wine/Proton only, and intentionally no beta/nightly split in UI.
+        appendRemoteProfiles(wineProtonOverlayJson, false, false, true);
+        syncContents();
+    }
+
+    private void appendRemoteProfiles(String json, boolean includeBeta, boolean ignoreWine, boolean onlyWine) {
+        if (json == null || json.trim().isEmpty()) return;
         try {
-            remoteProfiles = new ArrayList<>();
             JSONArray content = new JSONArray(json);
             for (int i = 0; i < content.length(); i++) {
                 try {
@@ -114,6 +130,7 @@ public class ContentsManager {
                     remoteProfile.delivery = object.optString(ContentProfile.MARK_DELIVERY, ContentProfile.DELIVERY_REMOTE);
 
                     if (remoteProfile.type == null) continue;
+                    if (onlyWine && remoteProfile.type != ContentProfile.ContentType.CONTENT_TYPE_WINE) continue;
                     if (ignoreWine && remoteProfile.type == ContentProfile.ContentType.CONTENT_TYPE_WINE) continue;
                     if (remoteProfile.type == ContentProfile.ContentType.CONTENT_TYPE_BOX64
                             || remoteProfile.type == ContentProfile.ContentType.CONTENT_TYPE_WOWBOX64) {
@@ -129,6 +146,8 @@ public class ContentsManager {
                     remoteProfile.channel = channel;
                     boolean isBeta = ContentProfile.CHANNEL_BETA.equals(channel)
                             || ContentProfile.CHANNEL_NIGHTLY.equals(channel);
+                    // Wine/Proton overlay entries are intentionally presented as a single stable track in UI.
+                    if (onlyWine && isBeta) continue;
                     if (!includeBeta && isBeta) continue;
 
                     remoteProfiles.add(remoteProfile);
@@ -139,7 +158,6 @@ public class ContentsManager {
         } catch (JSONException e) {
             e.printStackTrace();
         }
-        syncContents();
     }
 
     public void syncContents() {
diff --git a/app/src/main/res/values/strings.xml b/app/src/main/res/values/strings.xml
index cc5d1a4..a26a658 100644
--- a/app/src/main/res/values/strings.xml
+++ b/app/src/main/res/values/strings.xml
@@ -344,7 +344,7 @@
     <string name="reinstall_imagefs">Reinstall Imagefs</string>
     <string name="do_you_want_to_reinstall_imagefs">Do you want to reinstall imagefs? This operation will restore system files, your containers won\'t be changed.</string>
     <string name="unable_to_remove_content_since_container_using">Unable to remove this content, because a container is currently using this Wine.</string>
-    <string name="get_more_contents_form_github">You can access our repository releases for Winlator CMOD Aero.so content packages (Wine/Proton and tools).</string>
+    <string name="get_more_contents_form_github">Content packages are loaded from WCP Hub, while Wine/Proton packages are provided from Aero.solator releases.</string>
     <string name="setup_failed">Setup failed</string>
     <string name="graphics_driver_configuration">Graphics Driver Configuration</string>
     <string name="select_graphics_driver_version">Select Graphics Driver Version:</string>
@@ -623,7 +623,7 @@ E.g. <b>META</b> for <i>META key</i>, \n
     <string name="unable_to_fetch_turnip_versions">Unable to fetch Turnip versions.</string>
     <string name="turnip_download_failed">Turnip download failed.</string>
     <string name="turnip_install_failed_or_exists">Turnip install failed or version is already installed.</string>
-    <string name="show_beta_releases">Show beta / nightly builds</string>
+    <string name="show_beta_releases">Show beta / nightly builds (WCP Hub content)</string>
     <string name="channel_stable">Stable</string>
     <string name="channel_beta">Beta</string>
     <string name="channel_nightly">Nightly</string>
-- 
2.43.0
