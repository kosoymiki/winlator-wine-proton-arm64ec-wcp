From f554b2164f7799f8a50e19c15c86919139211de2 Mon Sep 17 00:00:00 2001
From: Codex <codex@local>
Date: Tue, 24 Feb 2026 20:22:08 +0300
Subject: [PATCH] forensics: add launcher wrapper and pre-exec telemetry

---
 .../GuestProgramLauncherComponent.java        | 42 +++++++++++++++++++
 1 file changed, 42 insertions(+)

diff --git a/app/src/main/java/com/winlator/cmod/xenvironment/components/GuestProgramLauncherComponent.java b/app/src/main/java/com/winlator/cmod/xenvironment/components/GuestProgramLauncherComponent.java
index f864f1e..8190ba8 100644
--- a/app/src/main/java/com/winlator/cmod/xenvironment/components/GuestProgramLauncherComponent.java
+++ b/app/src/main/java/com/winlator/cmod/xenvironment/components/GuestProgramLauncherComponent.java
@@ -409,6 +409,34 @@ public class GuestProgramLauncherComponent extends EnvironmentComponent {
 
         String wineRuntimeClass = detectWineRuntimeClass(wineBinPath);
         envVars.put("WINLATOR_WINE_RUNTIME_CLASS", wineRuntimeClass);
+        if (forensicMode || !isEmpty(forensicTraceId)) {
+            File wineDir = new File(imageFs.getWinePath());
+            File wineWrapper = new File(wineDir, "bin/wine");
+            File wineReal = new File(wineDir, "bin/wine.glibc-real");
+            File wineserverWrapper = new File(wineDir, "bin/wineserver");
+            File wineserverReal = new File(wineDir, "bin/wineserver.glibc-real");
+            File glibcLoader = new File(wineDir, "lib/wine/wcp-glibc-runtime/ld-linux-aarch64.so.1");
+            File glibcLibc = new File(wineDir, "lib/wine/wcp-glibc-runtime/libc.so.6");
+            ForensicLogger.logEvent(context, "info", "RUNTIME_WINE_WRAPPER_SELECTED", forensicTraceId, "launcher",
+                    "Resolved Wine launcher runtime class and wrapper artifacts",
+                    ForensicLogger.fields(
+                            "container_id", container != null ? container.id : 0,
+                            "route", forensicRouteSource,
+                            "wine_version", container != null ? container.getWineVersion() : "",
+                            "wine_path", imageFs.getWinePath(),
+                            "wine_runtime_class", wineRuntimeClass,
+                            "wine_wrapper_exists", wineWrapper.isFile(),
+                            "wine_wrapper_size", wineWrapper.isFile() ? wineWrapper.length() : 0,
+                            "wine_glibc_real_exists", wineReal.isFile(),
+                            "wine_glibc_real_size", wineReal.isFile() ? wineReal.length() : 0,
+                            "wineserver_wrapper_exists", wineserverWrapper.isFile(),
+                            "wineserver_glibc_real_exists", wineserverReal.isFile(),
+                            "glibc_loader_exists", glibcLoader.isFile(),
+                            "glibc_libc_exists", glibcLibc.isFile(),
+                            "fex_log_enabled", !isEmpty(envVars.get("FEX_LOG_FILE")),
+                            "vulkan_dump_enabled", !isEmpty(envVars.get("VK_APIDUMP_OUTPUT_FILENAME")),
+                            "turnip_log_enabled", !isEmpty(envVars.get("MESA_LOG_FILE")) || !isEmpty(envVars.get("TU_DEBUG_LOG")))));
+        }
         boolean upscaleLaunchEnvNormalized = normalizeUpscaleLaunchEnvVars(envVars);
         if (upscaleLaunchEnvNormalized && (forensicMode || !isEmpty(forensicTraceId))) {
             ForensicLogger.logEvent(context, "warn", "RUNTIME_UPSCALE_LAUNCH_ENV_NORMALIZED", forensicTraceId, "launcher",
@@ -454,6 +482,20 @@ public class GuestProgramLauncherComponent extends EnvironmentComponent {
         }
 
         if (forensicMode || !isEmpty(forensicTraceId)) {
+            ForensicLogger.logEvent(context, "info", "RUNTIME_PRE_EXEC_STAGE", forensicTraceId, "launcher",
+                    "Final launcher pre-exec stage reached",
+                    ForensicLogger.fields(
+                            "container_id", container != null ? container.id : 0,
+                            "route", forensicRouteSource,
+                            "wine_runtime_class", wineRuntimeClass,
+                            "glibc_tunables", envVars.get("GLIBC_TUNABLES"),
+                            "ld_preload", envVars.get("LD_PRELOAD"),
+                            "ld_library_path", envVars.get("LD_LIBRARY_PATH"),
+                            "wine_debug_len", envVars.get("WINEDEBUG").length(),
+                            "fex_log_file", envVars.get("FEX_LOG_FILE"),
+                            "vk_api_dump_file", envVars.get("VK_APIDUMP_OUTPUT_FILENAME"),
+                            "mesa_log_file", envVars.get("MESA_LOG_FILE"),
+                            "tu_debug_log", envVars.get("TU_DEBUG_LOG")));
             ForensicLogger.logEvent(context, "info", "LAUNCH_EXEC_SUBMIT", forensicTraceId, "launcher",
                     "Submitting guest process execution",
                     ForensicLogger.fields(
-- 
2.43.0

